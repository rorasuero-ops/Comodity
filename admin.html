<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Comodity – Admin publicaciones</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // MISMA CONFIG QUE EN INDEX
    const firebaseConfig = {
      apiKey: "AIzaSyC7QcScbqc5dWL4WCatnemf_KGCaZtjCT4",
      authDomain: "comodity-9a7be.firebaseapp.com",
      projectId: "comodity-9a7be",
      storageBucket: "comodity-9a7be.firebasestorage.app",
      messagingSenderId: "560121634288",
      appId: "1:560121634288:web:e02bdad21bd4ee06255135",
      measurementId: "G-PYNZCB10T0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Cargar publicaciones y manejar form
    window.addEventListener("load", () => {
      const loadingEl  = document.getElementById("admin-loading");
      const contentEl  = document.getElementById("admin-content");
      const userEmailSpan = document.getElementById("admin-user-email");
      const form = document.getElementById("pub-form");

      loadingEl.style.display = "block";
      contentEl.style.display = "none";

      auth.onAuthStateChanged(user => {
        loadingEl.style.display = "none";

        if (!user) {
          // Si no está logueado, igual mostramos el panel pero avisamos
          userEmailSpan.textContent = "Invitado (iniciá sesión en la app)";
        } else {
          userEmailSpan.textContent = user.email || "";
        }

        contentEl.style.display = "block";
        cargarPublicaciones();
      });

      // Enviar formulario: crear publicación en Firestore
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombre       = document.getElementById("pub-nombre").value.trim();
        const descripcion  = document.getElementById("pub-desc").value.trim();
        const categoria    = document.getElementById("pub-cat").value.trim();
        const fotoUrl      = document.getElementById("pub-foto").value.trim();
        const precioAntes  = parseFloat(document.getElementById("pub-precio-antes").value || "0");
        const precioDesp   = parseFloat(document.getElementById("pub-precio-despues").value || "0");
        const horasRest    = parseFloat(document.getElementById("pub-horas").value || "24");
        const vendedor     = document.getElementById("pub-vendedor").value.trim();

        if (!nombre || !categoria || !precioDesp) {
          alert("Nombre, categoría y precio después son obligatorios.");
          return;
        }

        try {
          await db.collection("publicaciones").add({
            nombre,
            descripcion,
            categoria,          // ej: "comida", "celulares", "muebles"
            fotoUrl,
            precioAntes: isNaN(precioAntes) ? null : precioAntes,
            precioDespues: isNaN(precioDesp) ? null : precioDesp,
            horasRestantes: isNaN(horasRest) ? 24 : horasRest,
            vendedor,
            creadoEn: firebase.firestore.FieldValue.serverTimestamp()
          });

          form.reset();
          document.getElementById("pub-horas").value = "24";
          alert("Publicación guardada en Firestore ✅");
          cargarPublicaciones();
        } catch (err) {
          console.error(err);
          alert("Error al guardar la publicación: " + err.message);
        }
      });
    });

    // Obtener y mostrar publicaciones en la tabla
    async function cargarPublicaciones() {
      const tbody = document.getElementById("pub-list");
      tbody.innerHTML = "<tr><td colspan='6'>Cargando...</td></tr>";

      try {
        const snap = await db
          .collection("publicaciones")
          .orderBy("creadoEn", "desc")
          .limit(50)
          .get();

        if (snap.empty) {
          tbody.innerHTML = "<tr><td colspan='6'>Todavía no hay publicaciones.</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.nombre || ""}</td>
            <td>${d.categoria || ""}</td>
            <td>${d.vendedor || ""}</td>
            <td>${d.precioAntes ? "$ " + d.precioAntes : "-"}</td>
            <td>${d.precioDespues ? "$ " + d.precioDespues : "-"}</td>
            <td>${d.horasRestantes || "-"} h</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='6'>Error al cargar publicaciones.</td></tr>";
      }
    }

    async function adminLogout() {
      try {
        await auth.signOut();
        window.location.href = "index.html";
      } catch (e) {
        console.error(e);
        alert("Error al cerrar sesión: " + e.message);
      }
    }

    // Hacemos visible la función para el botón
    window.adminLogout = adminLogout;
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background:#f5f5f5;
      color:#222;
    }
    .admin-header {
      background:#f44336;
      color:#fff;
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .admin-title {
      font-size:18px;
      font-weight:bold;
    }
    .admin-main {
      max-width:1000px;
      margin:20px auto;
      background:#fff;
      border-radius:12px;
      padding:16px 18px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .btn {
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:bold;
    }
    .btn-logout {
      background:#fff;
      color:#f44336;
    }
    .btn-submit {
      background:#f44336;
      color:#fff;
    }
    .small {
      font-size:13px;
      color:#555;
    }
    label {
      display:block;
      margin:8px 0 4px;
      font-size:13px;
    }
    input, textarea, select {
      width:100%;
      padding:6px 8px;
      font-size:13px;
      border-radius:8px;
      border:1px solid #ccc;
      box-sizing:border-box;
    }
    textarea {
      resize:vertical;
      min-height:60px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td {
      border-bottom:1px solid #eee;
      padding:6px 4px;
      text-align:left;
    }
    th {
      background:#fafafa;
      font-weight:bold;
    }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-title">Panel Admin – Publicaciones Comodity</div>
    <div class="small">
      <span id="admin-user-email"></span>
      &nbsp;|&nbsp;
      <button class="btn btn-logout" onclick="adminLogout()">Cerrar sesión</button>
    </div>
  </header>

  <div id="admin-loading" class="admin-main">
    Verificando sesión...
  </div>

  <div id="admin-content" class="admin-main" style="display:none;">
    <h2>Cargar nueva publicación</h2>
    <p class="small">
      Estas publicaciones se guardan en Firestore y se mostrarán a los usuarios en la categoría correspondiente.
    </p>

    <form id="pub-form">
      <label>Nombre del producto *</label>
      <input type="text" id="pub-nombre" placeholder="Ej: Smart TV TCL 50&quot;" required />

      <label>Descripción</label>
      <textarea id="pub-desc" placeholder="Detalle que va a ver el usuario"></textarea>

      <label>Categoría (coincide con data-cat de la app) *</label>
      <input type="text" id="pub-cat" placeholder="Ej: comida, celulares, muebles, electro, hoteles..." required />

      <label>URL de la foto (por ahora un link a la imagen)</label>
      <input type="text" id="pub-foto" placeholder="https://..." />

      <label>Precio ANTES (opcional)</label>
      <input type="number" id="pub-precio-antes" placeholder="Ej: 2000" />

      <label>Precio DESPUÉS *</label>
      <input type="number" id="pub-precio-despues" placeholder="Ej: 899" required />

      <label>Horas restantes (para el contador) *</label>
      <input type="number" id="pub-horas" value="24" />

      <label>Nombre del vendedor / comercio</label>
      <input type="text" id="pub-vendedor" placeholder="Ej: PizzaRocket, MuebleBox..." />

      <button type="submit" class="btn btn-submit" style="margin-top:10px;">
        Guardar publicación
      </button>
    </form>

    <hr style="margin:20px 0;">

    <h2>Últimas publicaciones cargadas</h2>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Vendedor</th>
          <th>Antes</th>
          <th>Después</th>
          <th>Horas</th>
        </tr>
      </thead>
      <tbody id="pub-list">
        <!-- se llena por JS -->
      </tbody>
    </table>
  </div>

</body>
</html>
