<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Firebase compat (ideal para HTML puro sin build) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7QcScbqc5dWL4WCatnemf_KGCaZtjCT4",
      authDomain: "comodity-9a7be.firebaseapp.com",
      projectId: "comodity-9a7be",
      storageBucket: "comodity-9a7be.firebasestorage.app",
      messagingSenderId: "560121634288",
      appId: "1:560121634288:web:e02bdad21bd4ee06255135",
      measurementId: "G-PYNZCB10T0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore(); //
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comodity</title>

<style>
    :root {
      --primary: #f44336;
      --accent: #c62828;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text-main: #111;
      --text-soft: #555;
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    /* LOGIN */

    #login-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #ff8a80, #b71c1c);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }

    .login-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 22px 20px 18px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      text-align: center;
    }

    .login-logo {
      margin-bottom: 10px;
    }

    .login-logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 54px;
      height: 54px;
      background: #fff3e0;
      color: #000;
      font-size: 24px;
      font-weight: bold;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .login-title {
      font-size: 20px;
      font-weight: bold;
      margin-top: 8px;
    }

    .login-subtitle {
      font-size: 13px;
      color: var(--text-soft);
      margin: 4px 0 12px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-align: left;
    }

    .login-form label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .login-form input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .login-button {
      margin-top: 6px;
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
    }

    .login-button.google {
      margin-top: 10px;
      background: #4285f4;
    }

    .login-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .link-like {
      border: none;
      background: none;
      padding: 0;
      margin: 0;
      font-size: 11px;
      color: #ffffff;
      cursor: pointer;
      text-decoration: underline;
    }

    /* APP PRINCIPAL */

    #app {
      display: none;
    }

    header {
      background: var(--primary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #fff;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    /* -------------------------- */
    /* NUEVO HEADER ORDENADO      */
    /* -------------------------- */

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-start;   /* Alinea todo a la izquierda */
      gap: 4px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-header {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      background: #ffffff;
      color: #000;
      font-size: 22px;
      font-weight: bold;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .title-text {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }

    .admin-link {
      padding: 6px 14px;
      border-radius: 999px;
      background: #ffffff;
      color: #f44336;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      border: none;
      cursor: pointer;
      margin-left: 50px;   /* lo deja alineado visualmente con el texto */
      margin-top: 2px;
    }

    .admin-link:hover {
      background: #ffe3df;
    }

    /* -------------------------- */

    .user-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #fff;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .user-text {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .user-name {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }

    .user-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
    }

    .badge-balance {
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-balance strong {
      font-weight: 700;
      letter-spacing: .02em;
    }

    .badge-balance .label {
      font-size: 11px;
      text-transform: uppercase;
    }

    .icon-badge { font-size: 14px; }

    .badge-balance .value { font-weight: bold; }

    .badge-coupons {
      cursor: pointer;
      border: 1px dashed rgba(255,255,255,0.7);
    }

    .badge-lightning {
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.6);
    }

    /* ------------------------------------------------ */
    /* LOGO ORIGINAL (RULETA) ‚Äî NO TOCAR                */
    /* ------------------------------------------------ */
    .logo-center {
      width: 54px;
      height: 54px;
      background: #ffffff;
      color: #000;
      font-size: 26px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }
    /* ------------------------------------------------ */


    /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî SIGUE TODO TU CSS, SIN CAMBIOS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */

    .user-menu {
      position: fixed;
      top: 56px;
      left: 16px;
      background: #ffffff;
      color: #333;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      padding: 6px 0;
      display: none;
      z-index: 1100;
      min-width: 180px;
      font-size: 14px;
    }

    .user-menu-item {
      padding: 8px 14px;
      cursor: pointer;
    }

    .user-menu-item:hover {
      background: #f5f5f5;
    }

    main {
      padding-bottom: 24px;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    /* ----- LAYOUT HOME TOP (banners + ruleta) ----- */

    .home-top {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr) minmax(0, 1.2fr);
      gap: 14px;
      margin: 16px 16px 8px;
    }

    .home-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .home-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      padding: 12px 14px;
    }

    .home-card-title {
      font-size: 16px;
      font-weight: 800;
      margin: 0 0 6px;
      color: #222;
      letter-spacing: .01em;
    }

    .home-card-title span {
      color: var(--primary);
    }

    .home-card-subtitle {
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî (RESTO DEL CSS COMPLETO SIGUE IGUAL) ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */

</style>

</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">C</div>
    </div>
    <div class="login-title">Ingres√° a Comodity</div>
    <div class="login-subtitle">Gir√° la ruleta y acumul√° saldo y cupones para tus compras.</div>

    <form id="login-form" class="login-form">
      <div id="login-name-group">
        <label for="login-name">Nombre</label>
        <input id="login-name" type="text" placeholder="Ej: Javier Araujo" />
      </div>
      <div>
        <label for="login-email">Email</label>
        <input id="login-email" type="email" placeholder="tucorreo@example.com" required />
      </div>
      <div>
        <label for="login-password">Contrase√±a</label>
        <input id="login-password" type="password" placeholder="‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè" required />
      </div>
      <button type="submit" class="login-button" id="login-submit-btn">Entrar</button>
      <button type="button" class="login-button google" onclick="loginWithGoogle()">
        Continuar con Google
      </button>
    </form>

    <div class="login-note">
      <span id="login-mode-message">¬øNo ten√©s cuenta?</span>
      <button type="button" id="toggle-login-mode" class="link-like">Crear cuenta</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
<header class="main-header">
  
  <!-- IZQUIERDA: Avatar + nombres + balances (SE MANTIENE IGUAL) -->
  <div class="header-left">
    <div class="user-avatar" id="user-avatar">üë§</div>
    <div class="user-text">
      <div id="user-name" class="user-name">Invitado</div>
      <div class="user-balances">
        <div class="badge-balance">
          <span class="icon-badge">$</span>
          <span class="label">Libre:</span>
          <strong>$<span id="saldo-libre" class="value">0</span></strong>
        </div>
        <div class="badge-balance badge-lightning" onclick="openLightningInfo()">
          <span class="icon-badge">‚ö°</span>
          <span class="label">Lightning:</span>
          <strong>$<span id="saldo-light" class="value">0</span></strong>
        </div>
        <div class="badge-balance badge-coupons" onclick="openCouponsPopup()">
          <span class="icon-badge">üéüÔ∏è</span>
          <span class="label">Cupones:</span>
          <strong><span id="cupones-count" class="value">0</span></strong>
        </div>
      </div>
    </div>
  </div>

  <!-- DERECHA: Logo + Comodity + Admin ORDENADO -->
  <div class="header-right">
  <div class="header-brand">
    <div class="logo-header">C</div>
    <div class="title-text">Comodity</div>
  </div>

  <a id="admin-link" href="admin.html" class="admin-link">
    Admin
  </a>
</div
  </div>

</header>


  <!-- Men√∫ usuario -->
  <div id="user-menu" class="user-menu">
    <div class="user-menu-item" onclick="openProfileOverlay()">Datos personales</div>
    <div class="user-menu-item" onclick="openReferralsScreen()">Invitar amigos</div>
    <div class="user-menu-item" onclick="logout()">Cerrar sesi√≥n</div>
  </div>

  <main>
    <!-- HOME -->
    <div id="home-screen" class="screen active">

      <div class="home-top">
        <!-- Columna izquierda: sorteo + invitar -->
        <div class="home-column">
          <!-- Sorteo -->
          <div class="home-card">
            <h3 class="home-card-title">
              Pr√≥ximo sorteo <span>Smart TV TCL 50"</span>
            </h3>
            <div class="raffle-main">
              <div class="raffle-text-block">
                <div class="home-card-subtitle">
                  Jug√° a la ruleta todos los d√≠as y particip√° del sorteo.
                </div>
                <div class="raffle-date" id="raffle-date-label"></div>
                <a href="#" class="raffle-conditions">Ver condiciones</a>
              </div>
              <img src="img/banner_tcl.jpg" alt="Smart TV TCL" class="raffle-tv-img">
            </div>
          </div>

          <!-- Invitar amigo -->
          <div class="home-card">
            <h3 class="home-card-title">
              Invit√° a un amigo y ganen <span>8 tiradas gratis</span>
            </h3>
            <div class="invite-main">
              <div class="home-card-subtitle">
                Compart√≠ tu link. Cuando tu amigo se registre y juegue, los dos reciben tiradas extra.
              </div>
              <button class="invite-btn" onclick="openReferralsScreen()">Invitar</button>
              <div class="invite-bottom">
                <div class="mini-wheel">
                  <div class="mini-wheel-center">C</div>
                </div>
                <img src="img/banner_mujer1.jpg" alt="Usuario feliz" class="invite-woman">
              </div>
            </div>
          </div>
        </div>

        <!-- Columna centro: ruleta -->
        <div class="ruleta-container">
          <div class="ruleta-title">Gir√° la ruleta y gan√° beneficios para tus compras</div>
          <div class="ruleta-wrapper">
            <div class="ruleta" id="ruleta">
              <div class="pointer"></div>
              <div class="ruleta-center">
                <div class="logo-center">C</div>
              </div>

              <div class="ruleta-segment-icon wheel-coin-yellow seg-1">$</div>
              <div class="ruleta-segment-icon wheel-percent     seg-2">%</div>
              <div class="ruleta-segment-icon wheel-coin-blue   seg-3">$</div>
              <div class="ruleta-segment-icon wheel-coin-yellow seg-4">$</div>
              <div class="ruleta-segment-icon wheel-percent     seg-5">%</div>
              <div class="ruleta-segment-icon wheel-coin-blue   seg-6">$</div>
              <div class="ruleta-segment-icon wheel-coin-yellow seg-7">$</div>
              <div class="ruleta-segment-icon wheel-coin-blue   seg-8">$</div>
            </div>

            <button class="btn-girar" id="btn-girar" onclick="girarRuleta()">
              Girar ruleta
            </button>
          </div>
          <p id="resultado"></p>
          <p id="tiradas-info" class="tiradas-info">4 tiradas restantes</p>
          <p id="cooldown-info" class="cooldown-info" style="display:none;">
            Pr√≥xima recarga en <span id="cooldown-seconds">12:00:00</span>
          </p>
        </div>

        <!-- Columna derecha: Ofertas -->
        <div class="home-column">
          <div class="home-card">
            <h3 class="offers-title">Ofertas exclusivas de Comodity</h3>
            <div class="offers-subtitle">
              Descuentos temporales que solo encontr√°s jugando a la ruleta.
            </div>
            <div class="offers-list">
              <!-- Zapatillas -->
              <div class="offer-item">
                <img src="img/banner_zapatillas.jpg" class="offer-img" alt="Zapatillas running">
                <div class="offer-info">
                  <div class="offer-name">Zapatillas de running</div>
                  <div class="offer-prices">
                    <span class="old">$ 2.000</span>
                    <span class="now">$ 899</span>
                  </div>
                  <div class="offer-timer" data-seconds="86400"></div>
                </div>
              </div>
              <!-- Auriculares -->
              <div class="offer-item">
                <img src="img/banner_auriculares.jpg" class="offer-img" alt="Auriculares inal√°mbricos">
                <div class="offer-info">
                  <div class="offer-name">Auriculares inal√°mbricos</div>
                  <div class="offer-prices">
                    <span class="old">$ 450</span>
                    <span class="now">$ 179</span>
                  </div>
                  <div class="offer-timer" data-seconds="252000"></div> <!-- 70h -->
                </div>
              </div>
              <!-- Fiter -->
              <div class="offer-item">
                <img src="img/banner_fiter.jpg" class="offer-img" alt="Membres√≠a Fiter">
                <div class="offer-info">
                  <div class="offer-name">Membres√≠a Fiter 3 meses</div>
                  <div class="offer-prices">
                    <span class="old">$ 1.900/mes</span>
                    <span class="now">$ 1.290/mes</span>
                  </div>
                  <div class="offer-timer" data-seconds="108000"></div> <!-- 30h -->
                </div>
              </div>
              <!-- Smart TV -->
              <div class="offer-item">
                <img src="img/banner_tcl.jpg" class="offer-img" alt="Smart TV TCL">
                <div class="offer-info">
                  <div class="offer-name">Smart TV TCL 50" oferta rel√°mpago</div>
                  <div class="offer-prices">
                    <span class="old">$ 499</span>
                    <span class="now">$ 325</span>
                  </div>
                  <div class="offer-timer" data-seconds="57600"></div> <!-- 16h -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
            <!-- CATEGOR√çAS -->
      <div class="categorias">
        <div class="categoria" data-cat="commodities">
          <div class="cat-img cat-img-comodities">
            <div class="cat-discount-badge">hasta<br><span class="off">50% OFF</span></div>
            <div class="cat-logo-comodity">C</div>
          </div>
          <div class="cat-bottom"><span>Commodities</span></div>
        </div>

        <div class="categoria" data-cat="insumos">
          <div class="cat-img cat-img-insumos">
            <div class="cat-discount-badge">hasta<br><span class="off">35% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Insumos constructivos</span></div>
        </div>

        <div class="categoria" data-cat="celulares">
          <div class="cat-img cat-img-cell">
            <div class="cat-discount-badge">hasta<br><span class="off">40% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Celulares</span></div>
        </div>

        <div class="categoria" data-cat="electronica">
          <div class="cat-img cat-img-electronica">
            <div class="cat-discount-badge">hasta<br><span class="off">45% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Electr√≥nica, audio y video</span></div>
        </div>

        <div class="categoria" data-cat="ropa">
          <div class="cat-img cat-img-ropa">
            <div class="cat-discount-badge">hasta<br><span class="off">30% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Ropa</span></div>
        </div>

        <div class="categoria" data-cat="experiencias">
          <div class="cat-img cat-img-experiencias">
            <div class="cat-discount-badge">hasta<br><span class="off">60% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Experiencias</span></div>
        </div>

        <div class="categoria" data-cat="imperdibles">
          <div class="cat-img cat-img-imperdibles">
            <div class="cat-discount-badge">hasta<br><span class="off">70% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Imperdibles &lt; $1000</span></div>
        </div>

        <div class="categoria" data-cat="hoteles">
          <div class="cat-img cat-img-hoteles">
            <div class="cat-discount-badge">hasta<br><span class="off">55% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Hoteles y viajes</span></div>
        </div>

        <div class="categoria" data-cat="muebles">
          <div class="cat-img cat-img-muebles">
            <div class="cat-discount-badge">hasta<br><span class="off">45% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Muebles y hogar</span></div>
        </div>

        <div class="categoria" data-cat="deportes">
          <div class="cat-img cat-img-deportes">
            <div class="cat-discount-badge">hasta<br><span class="off">40% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Deportes y fitness</span></div>
        </div>

        <div class="categoria" data-cat="comida">
          <div class="cat-img cat-img-comida">
            <div class="cat-discount-badge">hasta<br><span class="off">35% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Comida</span></div>
        </div>

        <div class="categoria" data-cat="electro">
          <div class="cat-img cat-img-electro">
            <div class="cat-discount-badge">hasta<br><span class="off">40% OFF</span></div>
          </div>
          <div class="cat-bottom"><span>Electrodom√©sticos</span></div>
        </div>
      </div>
    </div>

    <!-- Pantalla Celulares -->
    <div id="cellphones-screen" class="screen">
      <div class="back-bar">
        <button class="back-link" onclick="goToHome()">‚Üê Volver</button>
      </div>
      <div class="cellphones-title">Celulares en oferta</div>
      <div class="cellphones-subtitle">
        Ofertas con 20% OFF por tiempo limitado. El descuento termina al final del d√≠a.
      </div>
      <div class="cellphones-grid" id="cellphones-grid"></div>
    </div>

    <!-- Pantalla Referidos -->
    <div id="referrals-screen" class="screen">
      <div class="back-bar">
        <button class="back-link" onclick="goToHome()">‚Üê Volver</button>
      </div>
      <div class="ref-title">Invit√° amigos y ganen tiradas extra</div>
      <div class="ref-subtitle">
        Compart√≠ tu link √∫nico. Cuando tus amigos se registran y juegan, ambos reciben 8 tiradas gratis.
      </div>

      <div class="ref-card">
        <div class="ref-label">Tu link de invitaci√≥n</div>
        <div class="ref-link-row">
          <input id="ref-link-input" class="ref-link-input" readonly>
          <button class="ref-copy-btn" onclick="copyReferralLink()">Copiar</button>
        </div>
      </div>
      <div class="ref-card">
        <div class="ref-label">C√≥mo funciona</div>
        <div class="cell-detail-text">
          1. Compart√≠ tu link con amigos.<br>
          2. Cuando se registran y juegan la ruleta, ambos reciben tiradas extra.<br>
          3. Cuantos m√°s amigos invites, m√°s tiradas pod√©s acumular.
        </div>
      </div>

      <div class="ref-wheel-wrapper">
        <div class="ref-mini-ruleta">
          <div class="ref-mini-center">C</div>
        </div>
      </div>
    </div>

    <!-- Pantalla Categor√≠a din√°mica (Firestore) -->
    <div id="category-screen" class="screen">
      <div class="back-bar">
        <button class="back-link" onclick="goToHome()">‚Üê Volver</button>
      </div>
      <div class="cellphones-title" id="category-title">Categor√≠a</div>
      <div class="cellphones-subtitle" id="category-subtitle">
        Ofertas cargadas desde el panel admin.
      </div>
      <div class="cellphones-grid" id="category-grid"></div>
    </div>
  </main>
</div>

<!-- POPUPS -->

<div id="reward-overlay" class="overlay">
  <div class="popup">
    <div id="reward-icon" class="reward-icon">üí∞</div>
    <div id="reward-title" class="reward-title">¬°Premio!</div>
    <div id="reward-desc" class="reward-desc">Ganaste algo.</div>
    <div id="reward-company" class="reward-company" style="display:none;">
      <span id="reward-company-logo" class="company-logo">BR</span>
      <span id="reward-company-text"></span>
    </div>
    <div id="reward-coins" class="reward-coins"></div>
    <button class="reward-close" onclick="closeRewardPopup()">Aceptar</button>
  </div>
</div>

<div id="coupons-overlay" class="overlay">
  <div class="popup">
    <div class="popup-title"><span>üéüÔ∏è</span><span>Mis cupones</span></div>
    <div class="popup-subtitle">Cupones de descuento que ganaste en la ruleta.</div>
    <div id="coupons-empty" class="coupon-empty">
      Todav√≠a no ten√©s cupones. Prob√° suerte girando la ruleta.
    </div>
    <div id="coupons-list" class="coupons-list"></div>
    <button class="popup-close" onclick="closeCouponsPopup()">Cerrar</button>
  </div>
</div>

<div id="profile-overlay" class="overlay">
  <div class="popup">
    <div class="reward-title">Datos personales</div>
    <form id="profile-form" class="profile-form">
      <label>Nombre completo
        <input type="text" id="profile-name" />
      </label>
      <label>Email
        <input type="email" id="profile-email" />
      </label>
      <label>Direcci√≥n
        <input type="text" id="profile-address" />
      </label>
      <label>Fecha de nacimiento
        <input type="date" id="profile-birthdate" />
      </label>
      <label>Tel√©fono
        <input type="tel" id="profile-phone" />
      </label>
      <label>Foto de perfil
        <input type="file" id="profile-photo" accept="image/*" />
      </label>
      <button type="submit" class="reward-close">Guardar</button>
      <button type="button" class="popup-close" onclick="closeProfileOverlay()">Cancelar</button>
    </form>
  </div>
</div>

<div id="cell-detail-overlay" class="overlay">
  <div class="popup">
    <div id="cell-detail-title" class="cell-detail-title"></div>
    <img id="cell-detail-img" class="cell-detail-img" src="" alt="">
    <div id="cell-detail-prices" class="cell-detail-text"></div>
    <div id="cell-detail-extra" class="cell-detail-text"></div>
    <button class="popup-close" onclick="closeCellDetail()">Cerrar</button>
  </div>
</div>

<div id="lightning-overlay" class="overlay">
  <div class="popup">
    <div class="popup-title"><span>‚ö°</span><span>Saldo Lightning</span></div>
    <div class="popup-subtitle">
      Tu saldo lightning se usa en comercios asociados seleccionados dentro de Comodity.
    </div>
    <ul class="lightning-list">
      <li><strong>MuebleBox</strong> ‚Äì muebles y hogar.</li>
      <li><strong>FerreBuceo</strong> ‚Äì herramientas y ferreter√≠a.</li>
      <li><strong>PizzaRocket</strong> ‚Äì comida r√°pida seleccionada.</li>
    </ul>
    <button class="popup-close" onclick="closeLightningInfo()">Cerrar</button>
  </div>
</div>

<script>
  let saldoLibre = 0;
  let saldoLight = 0;
  let cupones = [];
  let tiradasRestantes = 4;
  let countdownTimer = null;
  let countdownSecondsRemaining = 0;
  let isSpinning = false;
  let audioCtx;
  let currentUser = null;
  let currentUserName = null;

  let profileData = {
    nombre: "",
    email: "",
    direccion: "",
    fechaNacimiento: "",
    telefono: "",
    photoDataUrl: ""
  };

  let isRegisterMode = false;
  let cellIntervals = [];

  const outcomes = [
    { label: "Sin premio, suerte a la pr√≥xima üò¢", type: "none", prob: 0.30 },
    { label: "$25 saldo libre", type: "saldoLibre", amount: 25, prob: 0.20 },
    { label: "$150 saldo libre", type: "saldoLibreJackpot", amount: 150, prob: 0.10 },
    { label: "30% de descuento en PizzaRocket", type: "descuentoPizza", prob: 0.20 },
    { label: "$80 saldo lightning para gastar en MuebleBox", type: "saldoLightMueble", amount: 80, prob: 0.10 },
    { label: "$20 saldo lightning para gastar en FerreBuceo", amount: 20, type: "saldoLightFerre", prob: 0.10 }
  ];

  function applyUserHeader() {
    const nameEl = document.getElementById("user-name");
    const avatarEl = document.getElementById("user-avatar");
    if (nameEl) nameEl.textContent = currentUserName || "Invitado";

    if (avatarEl) {
      if (profileData.photoDataUrl) {
        avatarEl.style.backgroundImage = `url(${profileData.photoDataUrl})`;
        avatarEl.textContent = "";
      } else {
        avatarEl.style.backgroundImage = "none";
        const initial = currentUserName && currentUserName.trim()
          ? currentUserName.trim().charAt(0).toUpperCase()
          : "üë§";
        avatarEl.textContent = initial;
      }
    }
  }

  function getUserKey(suffix) {
    if (!currentUser) return null;
    return "comodity_" + suffix + "_" + currentUser.uid;
  }

  function saveStateForUser() {
    const key = getUserKey("state");
    if (!key) return;
    const state = { saldoLibre, saldoLight, cupones, tiradasRestantes };
    localStorage.setItem(key, JSON.stringify(state));
  }

  function saveProfileForUser() {
    const key = getUserKey("profile");
    if (!key) return;
    const data = {
      nombre: currentUserName,
      email: profileData.email || "",
      direccion: profileData.direccion || "",
      fechaNacimiento: profileData.fechaNacimiento || "",
      telefono: profileData.telefono || "",
      photoDataUrl: profileData.photoDataUrl || ""
    };
    localStorage.setItem(key, JSON.stringify(data));
  }

  function loadUserData() {
    if (!currentUser) return;

    const stateKey = getUserKey("state");
    saldoLibre = 0;
    saldoLight = 0;
    cupones = [];
    tiradasRestantes = 4;

    if (stateKey) {
      const raw = localStorage.getItem(stateKey);
      if (raw) {
        try {
          const s = JSON.parse(raw);
          if (typeof s.saldoLibre === "number") saldoLibre = s.saldoLibre;
          if (typeof s.saldoLight === "number") saldoLight = s.saldoLight;
          if (Array.isArray(s.cupones)) cupones = s.cupones;
          if (typeof s.tiradasRestantes === "number") tiradasRestantes = s.tiradasRestantes;
        } catch {}
      }
    }

    const profileKey = getUserKey("profile");
    profileData = { nombre: "", email: "", direccion: "", fechaNacimiento: "", telefono: "", photoDataUrl: "" };
    if (profileKey) {
      const rawP = localStorage.getItem(profileKey);
      if (rawP) {
        try {
          const p = JSON.parse(rawP);
          profileData.nombre = p.nombre || "";
          profileData.email = p.email || "";
          profileData.direccion = p.direccion || "";
          profileData.fechaNacimiento = p.fechaNacimiento || "";
          profileData.telefono = p.telefono || "";
          profileData.photoDataUrl = p.photoDataUrl || "";
          if (profileData.nombre) currentUserName = profileData.nombre;
        } catch {}
      }
    }

    applyUserHeader();
    actualizarSaldos();
    actualizarCuponesCount();
    actualizarTiradas();
  }
  
  function handleUserLoggedIn(user, nameOverride) {
    currentUser = user;
    currentUserName = nameOverride || user.displayName || user.email;

    applyUserHeader();

    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app").style.display = "block";

    loadUserData();
    generateReferralLink();
  }

  function handleLoggedOut() {
    currentUser = null;
    currentUserName = null;
    saldoLibre = 0;
    saldoLight = 0;
    cupones = [];
    tiradasRestantes = 4;

    document.getElementById("app").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      handleUserLoggedIn(user);
    } else {
      handleLoggedOut();
    }
  });

  function toggleLoginMode() {
    isRegisterMode = !isRegisterMode;
    const nameGroup = document.getElementById("login-name-group");
    const submitBtn = document.getElementById("login-submit-btn");
    const msg = document.getElementById("login-mode-message");
    const toggleBtn = document.getElementById("toggle-login-mode");

    if (isRegisterMode) {
      nameGroup.style.display = "block";
      submitBtn.textContent = "Crear cuenta y entrar";
      msg.textContent = "¬øYa ten√©s cuenta?";
      toggleBtn.textContent = "Iniciar sesi√≥n";
    } else {
      nameGroup.style.display = "none";
      submitBtn.textContent = "Entrar";
      msg.textContent = "¬øNo ten√©s cuenta?";
      toggleBtn.textContent = "Crear cuenta";
    }
  }

  document.getElementById("toggle-login-mode").addEventListener("click", toggleLoginMode);

  document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const name  = document.getElementById("login-name").value.trim();
    const email = document.getElementById("login-email").value.trim();
    const pass  = document.getElementById("login-password").value.trim();

    if (isRegisterMode) {
      if (!name || !email || !pass) {
        alert("Complet√° nombre, email y contrase√±a para crear la cuenta.");
        return;
      }
      try {
        const credNew = await auth.createUserWithEmailAndPassword(email, pass);
        await credNew.user.updateProfile({ displayName: name });
        profileData.nombre = name;
        profileData.email = email;
        handleUserLoggedIn(credNew.user, name);
        saveProfileForUser();
      } catch (err2) {
        alert("Error al crear usuario: " + err2.message);
      }
    } else {
      if (!email || !pass) {
        alert("Complet√° email y contrase√±a.");
        return;
      }
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        handleUserLoggedIn(cred.user);
      } catch (err) {
        if (err.code === "auth/user-not-found") {
          alert("Usuario no encontrado. Cambi√° a 'Crear cuenta' para registrarte.");
        } else if (err.code === "auth/wrong-password") {
          alert("Contrase√±a incorrecta.");
        } else {
          alert("Error al iniciar sesi√≥n: " + err.message);
        }
      }
    }
  });

  async function loginWithGoogle() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      handleUserLoggedIn(user, user.displayName || user.email);
    } catch (err) {
      console.error(err);
      alert("Error al iniciar sesi√≥n con Google: " + err.message);
    }
  }

  async function logout() {
    try {
      await auth.signOut();
      document.getElementById("user-menu").style.display = "none";
    } catch (e) {
      console.error(e);
    }
  }

  function getAudioCtx() {
    if (!window.AudioContext && !window.webkitAudioContext) return null;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    return audioCtx;
  }

  function playSpinSoundSequence() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    for (let i = 0; i < 7; i++) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "triangle";
      const start = now + i * 0.08;
      const end   = start + 0.07;
      const f1 = 600 + i * 80;
      const f2 = f1 + 120;
      osc.frequency.setValueAtTime(f1, start);
      osc.frequency.linearRampToValueAtTime(f2, end);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.28, start + 0.02);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    }
  }

  function playWinSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    [523.25, 659.25, 783.99].forEach((f, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const start = now + i * 0.03;
      const end   = start + 0.35;
      osc.type = "sine";
      osc.frequency.setValueAtTime(f, start);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.4, start + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    });
  }

  function playJackpotSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    [523.25, 659.25, 783.99, 1046.5].forEach((f, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const start = now + i * 0.12;
      const end   = start + 0.4;
      osc.type = "square";
      osc.frequency.setValueAtTime(f, start);
      osc.frequency.linearRampToValueAtTime(f + 60, end);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.45, start + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    });
  }

  function playLoseSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(440, now);
    osc.frequency.linearRampToValueAtTime(220, now + 0.5);
    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
    gain.gain.linearRampToValueAtTime(0.0, now + 0.5);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(now); osc.stop(now + 0.5);
  }

  function playCoinRainSound() {
    const ctx = getAudioCtx();
    if (!ctx) return;

    const now = ctx.currentTime;

    for (let i = 0; i < 8; i++) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      const start = now + i * 0.05;
      const end   = start + 0.25;

      const baseFreq = 900 + Math.random() * 600;
      osc.type = "triangle";
      osc.frequency.setValueAtTime(baseFreq, start);
      osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.4, end);

      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.45, start + 0.03);
      gain.gain.exponentialRampToValueAtTime(0.02, end);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(start);
      osc.stop(end);
    }
  }

  function getRandomOutcomeWeighted() {
    const r = Math.random();
    let acc = 0;
    for (const o of outcomes) {
      acc += o.prob;
      if (r <= acc) return o;
    }
    return outcomes[outcomes.length - 1];
  }

  function actualizarSaldos() {
    document.getElementById("saldo-libre").textContent  = saldoLibre;
    document.getElementById("saldo-light").textContent  = saldoLight;
    saveStateForUser();
  }

  function actualizarCuponesCount() {
    document.getElementById("cupones-count").textContent = cupones.length;
    saveStateForUser();
  }

  function actualizarTiradas() {
    document.getElementById("tiradas-info").textContent =
      tiradasRestantes + " tiradas restantes";
    saveStateForUser();
  }

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function startCountdown12h() {
    const info  = document.getElementById("cooldown-info");
    const label = document.getElementById("cooldown-seconds");
    if (countdownTimer) clearInterval(countdownTimer);
    countdownSecondsRemaining = 12 * 60 * 60;
    info.style.display = "block";
    label.textContent = formatTime(countdownSecondsRemaining);
    countdownTimer = setInterval(() => {
      countdownSecondsRemaining--;
      if (countdownSecondsRemaining < 0) countdownSecondsRemaining = 0;
      label.textContent = formatTime(countdownSecondsRemaining);
      if (countdownSecondsRemaining <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
    }, 1000);
  }

  function stopCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = null;
    document.getElementById("cooldown-info").style.display = "none";
  }

  function showRewardPopup(kind, outcome) {
    const overlay      = document.getElementById("reward-overlay");
    const iconEl       = document.getElementById("reward-icon");
    const titleEl      = document.getElementById("reward-title");
    const descEl       = document.getElementById("reward-desc");
    const coinsEl      = document.getElementById("reward-coins");
    const companyWrap  = document.getElementById("reward-company");
    const companyLogo  = document.getElementById("reward-company-logo");
    const companyText  = document.getElementById("reward-company-text");

    let icon = "üí∞";
    let title = "¬°Premio!";
    let coinClass = "coin-yellow";
    let showCompany = false;

    if (kind === "libre") {
      icon = "üí∞"; title = "¬°Saldo libre ganado!"; coinClass="coin-yellow";
    } else if (kind === "jackpot") {
      icon = "üèÜ"; title = "¬°JACKPOT de saldo libre!"; coinClass="coin-yellow";
    } else if (kind === "descuento") {
      icon = "ÔºÖ"; title = "¬°Descuento desbloqueado!"; coinClass="coin-neutral"; showCompany = true;
      companyLogo.textContent = "PR";
      companyLogo.className = "company-logo company-pizza";
      companyText.textContent = "PizzaRocket";
    } else if (kind === "lightning-mueble") {
      icon = "‚ö°"; title = "Saldo lightning MuebleBox"; coinClass="coin-blue"; showCompany = true;
      companyLogo.textContent = "MB";
      companyLogo.className = "company-logo company-mueble";
      companyText.textContent = "MuebleBox";
    } else if (kind === "lightning-ferre") {
      icon = "‚ö°"; title = "Saldo lightning FerreBuceo"; coinClass="coin-blue"; showCompany = true;
      companyLogo.textContent = "FB";
      companyLogo.className = "company-logo company-ferre";
      companyText.textContent = "FerreBuceo";
    }

    iconEl.textContent = icon;
    titleEl.textContent = title;
    descEl.textContent  = outcome.label;
    companyWrap.style.display = showCompany ? "inline-flex" : "none";

    coinsEl.innerHTML = "";
    const coinCount = 10;

    for (let i = 0; i < coinCount; i++) {
      const c = document.createElement("div");
      c.className = "coin " + coinClass;
      const offsetX = (Math.random() - 0.5) * 120;
      c.style.setProperty("--coin-x", offsetX + "px");
      const delay = Math.random() * 0.25;
      c.style.animationDelay = delay + "s";
      c.textContent = kind === "descuento"
        ? "%"
        : (kind.startsWith("lightning") ? "‚ö°" : "$");
      coinsEl.appendChild(c);
    }

    overlay.style.display = "flex";

    if (
      kind === "libre" ||
      kind === "jackpot" ||
      kind === "lightning-mueble" ||
      kind === "lightning-ferre"
    ) {
      playCoinRainSound();
    }
  }

  function closeRewardPopup() {
    document.getElementById("reward-overlay").style.display = "none";
  }

  function agregarCupon(coupon) {
    cupones.push(coupon);
    actualizarCuponesCount();
  }

  function openCouponsPopup() {
    const overlay = document.getElementById("coupons-overlay");
    const listEl  = document.getElementById("coupons-list");
    const emptyEl = document.getElementById("coupons-empty");
    listEl.innerHTML = "";
    if (cupones.length === 0) {
      emptyEl.style.display = "block";
    } else {
      emptyEl.style.display = "none";
      cupones.forEach(c => {
        const item = document.createElement("div");
        item.className = "coupon-item";
        item.innerHTML = `
          <div class="coupon-logo">%</div>
          <div class="coupon-text">
            <div class="coupon-brand">${c.brand}</div>
            <div class="coupon-desc">${c.description}</div>
          </div>`;
        listEl.appendChild(item);
      });
    }
    overlay.style.display = "flex";
  }

  function closeCouponsPopup() {
    document.getElementById("coupons-overlay").style.display = "none";
  }

  function girarRuleta() {
    const ruleta    = document.getElementById("ruleta");
    const resultado = document.getElementById("resultado");
    const btn       = document.getElementById("btn-girar");
    if (isSpinning) return;
    isSpinning = true;

    if (tiradasRestantes <= 0) {
      tiradasRestantes = 4;
      stopCountdown();
    }
    tiradasRestantes--;
    actualizarTiradas();

    resultado.innerText = "Girando...";
    btn.disabled = true;

    ruleta.classList.remove("spin");
    void ruleta.offsetWidth;
    ruleta.classList.add("spin");

    playSpinSoundSequence();
    const outcome = getRandomOutcomeWeighted();

    setTimeout(() => {
      resultado.innerText = "Resultado: " + outcome.label;

      if (outcome.type === "saldoLibre" && outcome.amount) {
        saldoLibre += outcome.amount;
        actualizarSaldos();
        playWinSound();
        showRewardPopup("libre", outcome);
      } else if (outcome.type === "saldoLibreJackpot" && outcome.amount) {
        saldoLibre += outcome.amount;
        actualizarSaldos();
        playJackpotSound();
        showRewardPopup("jackpot", outcome);
      } else if ((outcome.type === "saldoLightMueble" || outcome.type === "saldoLightFerre") && outcome.amount) {
        saldoLight += outcome.amount;
        actualizarSaldos();
        playWinSound();
        if (outcome.type === "saldoLightMueble") {
          showRewardPopup("lightning-mueble", outcome);
        } else {
          showRewardPopup("lightning-ferre", outcome);
        }
      } else if (outcome.type === "descuentoPizza") {
        agregarCupon({ brand: "PizzaRocket", description: "30% de descuento en PizzaRocket" });
        playWinSound();
        showRewardPopup("descuento", outcome);
      } else if (outcome.type === "none") {
        playLoseSound();
      } else {
        playWinSound();
      }

      if (tiradasRestantes <= 0) startCountdown12h();

      btn.disabled = false;
      isSpinning   = false;
    }, 1500);
  }

  document.getElementById("user-avatar").addEventListener("click", function (e) {
    e.stopPropagation();
    const menu = document.getElementById("user-menu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
  });

  window.addEventListener("click", function(e) {
    const menu = document.getElementById("user-menu");
    if (!e.target.closest("#user-menu") && !e.target.closest("#user-avatar")) {
      menu.style.display = "none";
    }
  });

  function openProfileOverlay() {
    const menu = document.getElementById("user-menu");
    menu.style.display = "none";

    document.getElementById("profile-name").value =
      profileData.nombre || currentUserName || "";
    document.getElementById("profile-email").value =
      profileData.email || (currentUser ? currentUser.email : "");
    document.getElementById("profile-address").value =
      profileData.direccion || "";
    document.getElementById("profile-birthdate").value =
      profileData.fechaNacimiento || "";
    document.getElementById("profile-phone").value =
      profileData.telefono || "";

    document.getElementById("profile-overlay").style.display = "flex";
  }

  function closeProfileOverlay() {
    document.getElementById("profile-overlay").style.display = "none";
  }

  document.getElementById("profile-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const nombre = document.getElementById("profile-name").value.trim();
    const email = document.getElementById("profile-email").value.trim();
    const direccion = document.getElementById("profile-address").value.trim();
    const fechaNac = document.getElementById("profile-birthdate").value;
    const telefono = document.getElementById("profile-phone").value.trim();

    if (nombre) {
      currentUserName = nombre;
      profileData.nombre = nombre;
      if (currentUser) {
        try {
          await currentUser.updateProfile({ displayName: nombre });
        } catch (e) {
          console.error(e);
        }
      }
    }

    profileData.email = email;
    profileData.direccion = direccion;
    profileData.fechaNacimiento = fechaNac;
    profileData.telefono = telefono;

    applyUserHeader();
    saveProfileForUser();
    closeProfileOverlay();
  });

  document.getElementById("profile-photo").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      profileData.photoDataUrl = ev.target.result;
      saveProfileForUser();
      applyUserHeader();
    };
    reader.readAsDataURL(file);
  });

  function showScreen(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
  }

  function goToHome() {
    cellIntervals.forEach(i => clearInterval(i));
    cellIntervals = [];
    showScreen("home-screen");
  }

  function goToCellphones() {
    showScreen("cellphones-screen");
    renderCellphones();
  }

  function openReferralsScreen() {
    generateReferralLink();
    showScreen("referrals-screen");
  }

  // Mapa clave interna -> texto para el t√≠tulo
  const CATEGORY_LABELS = {
    commodities:  "Commodities",
    insumos:      "Insumos constructivos",
    celulares:    "Celulares",
    electronica:  "Electr√≥nica, audio y video",
    ropa:         "Ropa",
    experiencias: "Experiencias",
    imperdibles:  "Imperdibles < $1000",
    hoteles:      "Hoteles y viajes",
    muebles:      "Muebles y hogar",
    deportes:     "Deportes y fitness",
    comida:       "Comida",
    electro:      "Electrodom√©sticos"
  };

  document.addEventListener("click", function(e) {
    const cat = e.target.closest(".categoria");
    if (!cat) return;

    const key = cat.getAttribute("data-cat");
    if (!key) return;

    if (key === "celulares") {
      goToCellphones();
      return;
    }

    const label = CATEGORY_LABELS[key] || key;
    loadCategoryFromFirestore(key, label);
  });

  const cellphones = [
    {
      id: "cell1",
      name: "Samsung Galaxy S23 256GB",
      img: "https://images.samsung.com/is/image/samsung/p6pim/latin/2302/gallery/latin-galaxy-s23-s911-sm-s911bzidgto-534859593?$650_519_PNG$",
      priceNow: 29999
    },
    {
      id: "cell2",
      name: "iPhone 14 128GB",
      img: "https://store.storeimages.cdn-apple.com/4668/as-images.apple.com/is/iphone-14-blue-select-202209?wid=940&hei=1112&fmt=png-alpha&.v=1661027786801",
      priceNow: 38999
    },
    {
      id: "cell3",
      name: "Xiaomi Redmi Note 13 Pro",
      img: "https://i01.appmifile.com/webfile/globalimg/products/pc/redmi-note-13-pro-5g/specs01.png",
      priceNow: 21999
    },
    {
      id: "cell4",
      name: "Motorola Edge 40 Neo",
      img: "https://motorolaus.vtexassets.com/arquivos/ids/162093-800-auto?v=638293436464900000&width=800&height=auto&aspect=true",
      priceNow: 18999
    }
  ];

  function getOriginalPriceFromDiscount(nowPrice, discountPercent) {
    return Math.round(nowPrice / (1 - discountPercent / 100));
  }

  function formatPrice(uy) {
    return uy.toLocaleString("es-UY", { minimumFractionDigits: 0 });
  }

  function getEndOfDayTimestamp() {
    const now = new Date();
    const end = new Date(now);
    end.setHours(23, 59, 59, 999);
    return end.getTime();
  }

  function renderCellphones() {
    const grid = document.getElementById("cellphones-grid");
    grid.innerHTML = "";
    cellIntervals.forEach(i => clearInterval(i));
    cellIntervals = [];

    const deadline = getEndOfDayTimestamp();

    cellphones.forEach(cell => {
      const priceNow = cell.priceNow;
      const priceOld = getOriginalPriceFromDiscount(priceNow, 20);

      const card = document.createElement("div");
      card.className = "cell-card";
      card.setAttribute("data-id", cell.id);

      card.innerHTML = `
        <div class="cell-img-wrap">
          <img src="${cell.img}" alt="${cell.name}">
        </div>
        <div class="cell-body">
          <div class="cell-name">${cell.name}</div>
          <div class="cell-prices">
            <div class="cell-price-old">$${formatPrice(priceOld)}</div>
            <div class="cell-price-now">$${formatPrice(priceNow)}</div>
          </div>
          <div class="cell-discount-pill">
            <span>üî•</span><span>20% OFF hoy</span>
          </div>
          <div class="cell-timer" data-deadline="${deadline}">
            --
          </div>
        </div>
      `;

      card.addEventListener("click", () => {
        openCellDetail(cell, priceOld);
      });

      grid.appendChild(card);
    });

    document.querySelectorAll(".cell-timer").forEach(timerEl => {
      const dl = parseInt(timerEl.getAttribute("data-deadline"), 10);
      const interval = setInterval(() => {
        const now = Date.now();
        let diff = Math.max(0, dl - now);
        const h = Math.floor(diff / (1000 * 60 * 60));
        diff %= (1000 * 60 * 60);
        const m = Math.floor(diff / (1000 * 60));
        diff %= (1000 * 60);
        const s = Math.floor(diff / 1000);
        timerEl.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      }, 1000);
      cellIntervals.push(interval);
    });
  }

  function openCellDetail(cell, priceOld) {
    const overlay = document.getElementById("cell-detail-overlay");
    const tEl = document.getElementById("cell-detail-title");
    const imgEl = document.getElementById("cell-detail-img");
    const pricesEl = document.getElementById("cell-detail-prices");
    const extraEl = document.getElementById("cell-detail-extra");

    tEl.textContent = cell.name;
    imgEl.src = cell.img;

    const nowPrice = cell.priceNow;
    pricesEl.innerHTML = `
      <div><strong>Precio actual:</strong> $${formatPrice(nowPrice)} (20% OFF)</div>
      <div>Antes: <span style="text-decoration:line-through;color:#888;">$${formatPrice(priceOld)}</span></div>
    `;

    extraEl.innerHTML = `
      <div><strong>Vendedor:</strong> Comodity Store Oficial</div>
      <div><strong>Reputaci√≥n:</strong> ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4.8/5) ‚Ä¢ 1.250 ventas concretadas</div>
      <div><strong>Ubicaci√≥n:</strong> Montevideo, Uruguay</div>
      <div><strong>Env√≠o:</strong> Gratis en compras superiores a $2.000 ‚Ä¢ Llega entre 24 y 48 hs</div>
      <div><strong>Medios de pago:</strong> Tarjetas de cr√©dito, d√©bito y billeteras digitales.</div>
    `;

    overlay.style.display = "flex";
  }

  function closeCellDetail() {
    document.getElementById("cell-detail-overlay").style.display = "none";
  }

  function openLightningInfo() {
    document.getElementById("lightning-overlay").style.display = "flex";
  }

  function closeLightningInfo() {
    document.getElementById("lightning-overlay").style.display = "none";
  }

  function generateReferralLink() {
    const input = document.getElementById("ref-link-input");
    if (!input) return;
    const base = window.location.origin || "https://comodity.app";
    const uid = currentUser ? currentUser.uid : "demo";
    input.value = base + "/invite?ref=" + uid;
  }

  function copyReferralLink() {
    const input = document.getElementById("ref-link-input");
    if (!input || !input.value) return;
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Link copiado al portapapeles");
  }

  function initOfferCountdowns() {
    document.querySelectorAll(".offer-timer").forEach(timerEl => {
      let remaining = parseInt(timerEl.getAttribute("data-seconds"), 10);
      if (isNaN(remaining) || remaining <= 0) remaining = 3600;
      timerEl.textContent = formatTime(remaining);
      const interval = setInterval(() => {
        remaining--;
        if (remaining < 0) remaining = 0;
        timerEl.textContent = formatTime(remaining);
        if (remaining === 0) clearInterval(interval);
      }, 1000);
    });
  }

  function initRaffleDate() {
    const label = document.getElementById("raffle-date-label");
    if (!label) return;
    const now = new Date();
    const draw = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
    const opts = { day: "2-digit", month: "2-digit", year: "numeric" };
    label.textContent = "Sorteo: " + draw.toLocaleDateString("es-UY", opts);
  }

  window.addEventListener("load", () => {
    document.getElementById("login-name-group").style.display = "none";
    initOfferCountdowns();
    initRaffleDate();
    generateReferralLink();
  });

  async function loadCategoryFromFirestore(catKey, catLabel) {
    showScreen("category-screen");

    const titleEl = document.getElementById("category-title");
    const subEl   = document.getElementById("category-subtitle");
    const grid    = document.getElementById("category-grid");

    titleEl.textContent = catLabel;
    subEl.textContent   = "Ofertas en " + catLabel + " cargadas desde el panel admin.";
    grid.innerHTML      = "<p>Cargando publicaciones...</p>";

    try {
      const snap = await db
        .collection("publicaciones")
        .where("categoria", "==", catKey)
      
        .get();

      if (snap.empty) {
        grid.innerHTML = "<p style='padding:8px;'>Todav√≠a no hay publicaciones para esta categor√≠a.</p>";
        return;
      }

      grid.innerHTML = "";

      snap.forEach(doc => {
        const d = doc.data();

        const card = document.createElement("div");
        card.className = "cell-card";

        const precioAntes = d.precioAntes ? d.precioAntes.toLocaleString("es-UY") : null;
        const precioDesp  = d.precioDespues ? d.precioDespues.toLocaleString("es-UY") : null;

        card.innerHTML = `
          <div class="cell-img-wrap">
            <img src="${d.fotoUrl || "https://via.placeholder.com/200x200?text=Comodity"}" alt="${d.nombre || ""}">
          </div>
          <div class="cell-body">
            <div class="cell-name">${d.nombre || ""}</div>
            <div class="cell-prices">
              ${precioAntes ? `<div class="cell-price-old">$${precioAntes}</div>` : ""}
              ${precioDesp  ? `<div class="cell-price-now">$${precioDesp}</div>` : ""}
            </div>
            <div class="cell-discount-pill">
              <span>üî•</span>
              <span>${d.vendedor ? d.vendedor : "Comercio asociado"}</span>
            </div>
            <div class="cell-timer">
              Restan aprox. ${d.horasRestantes || 24} h
            </div>
          </div>
        `;

        card.addEventListener("click", () => {
          openCategoryDetail(d);
        });

        grid.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      grid.innerHTML = "<p style='padding:8px;'>Error al cargar publicaciones.</p>";
    }
  }

  function openCategoryDetail(d) {
    const overlay = document.getElementById("cell-detail-overlay");
    const tEl     = document.getElementById("cell-detail-title");
    const imgEl   = document.getElementById("cell-detail-img");
    const pricesEl= document.getElementById("cell-detail-prices");
    const extraEl = document.getElementById("cell-detail-extra");

    tEl.textContent = d.nombre || "";
    imgEl.src = d.fotoUrl || "https://via.placeholder.com/400x300?text=Comodity";

    const precioAntes = d.precioAntes ? d.precioAntes.toLocaleString("es-UY") : null;
    const precioDesp  = d.precioDespues ? d.precioDespues.toLocaleString("es-UY") : null;

    pricesEl.innerHTML = `
      ${precioDesp ? `<div><strong>Precio actual:</strong> $${precioDesp}</div>` : ""}
      ${precioAntes ? `<div>Antes: <span style="text-decoration:line-through;color:#888;">$${precioAntes}</span></div>` : ""}
    `;

    extraEl.innerHTML = `
      <div><strong>Vendedor:</strong> ${d.vendedor || "Comercio asociado"}</div>
      <div><strong>Descripci√≥n:</strong> ${d.descripcion || "Oferta especial de Comodity."}</div>
      <div><strong>Duraci√≥n:</strong> Aproximadamente ${d.horasRestantes || 24} horas desde su publicaci√≥n.</div>
    `;

    overlay.style.display = "flex";
  }
</script>

</body>
</html>


      
