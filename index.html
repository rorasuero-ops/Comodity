<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Firebase compat (ideal para HTML puro sin build) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7QcScbqc5dWL4WCatnemf_KGCaZtjCT4",
      authDomain: "comodity-9a7be.firebaseapp.com",
      projectId: "comodity-9a7be",
      storageBucket: "comodity-9a7be.firebasestorage.app",
      messagingSenderId: "560121634288",
      appId: "1:560121634288:web:e02bdad21bd4ee06255135",
      measurementId: "G-PYNZCB10T0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comodity</title>

  <style>
    :root {
      --primary: #f44336;
      --accent: #c62828;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text-main: #111;
      --text-soft: #555;
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
    }

    /* LOGIN */

    #login-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #ff8a80, #b71c1c);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }

    .login-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 22px 20px 18px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      text-align: center;
    }

    .login-logo {
      margin-bottom: 10px;
    }

    .login-logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 54px;
      height: 54px;
      background: #fff3e0;
      color: #000;
      font-size: 24px;
      font-weight: bold;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .login-title {
      font-size: 20px;
      font-weight: bold;
      margin-top: 8px;
    }

    .login-subtitle {
      font-size: 13px;
      color: var(--text-soft);
      margin: 4px 0 12px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-align: left;
    }

    .login-form label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .login-form input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .login-button {
      margin-top: 6px;
      width: 100%;
      padding: 9px 12px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
    }

    .login-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-soft);
      text-align: left;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .link-like {
      border: none;
      background: none;
      padding: 0;
      margin: 0;
      font-size: 11px;
      color: #ffffff;
      cursor: pointer;
      text-decoration: underline;
    }

    /* APP PRINCIPAL */

    #app {
      display: none;
    }

    /* HEADER */

    header {
      background: var(--primary);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #fff;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    .user-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }

    .user-balances {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
    }

    .badge-balance {
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .icon-badge { font-size: 13px; }

    .badge-balance .value { font-weight: bold; }

    .badge-coupons {
      cursor: pointer;
      border: 1px dashed rgba(255,255,255,0.7);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-big {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      background: #fff;
      color: #000;
      font-size: 22px;
      font-weight: bold;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .title-text {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
    }

    /* MENU USUARIO */

    .user-menu {
      position: fixed;
      top: 56px;
      left: 16px;
      background: #ffffff;
      color: #333;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      padding: 6px 0;
      display: none;
      z-index: 1100;
      min-width: 180px;
      font-size: 14px;
    }

    .user-menu-item {
      padding: 8px 14px;
      cursor: pointer;
    }

    .user-menu-item:hover {
      background: #f5f5f5;
    }

    /* PANTALLAS PRINCIPALES */

    main {
      padding-bottom: 24px;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    /* RULETA + LATERALES */

    .ruleta-container {
      background: var(--card-bg);
      margin: 20px;
      padding: 16px 16px 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .ruleta-title {
      font-size: 18px;
      margin: 0 0 12px;
      color: var(--text-soft);
      text-align: center;
    }

    .ruleta-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .ruleta-side {
      border-radius: 12px;
      border: 1px solid #ffcdd2;
      background: #fff;
      padding: 10px 12px;
      font-size: 13px;
    }

    .ruleta-side-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--accent);
    }

    .ruleta-side-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .sorteo-img {
      width: 100%;
      border-radius: 10px;
      margin: 6px 0 8px;
      object-fit: cover;
      max-height: 120px;
    }

    .sorteo-date {
      font-size: 12px;
      color: var(--text-soft);
    }

    .invite-box {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #ffcdd2;
    }

    .invite-title {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .invite-text {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .btn-small {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      font-weight: bold;
    }

    .ruleta-center-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .ruleta-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .ruleta {
      width: 230px;
      height: 230px;
      border-radius: 50%;
      position: relative;
      background:
        radial-gradient(circle at 30% 0%, rgba(255,255,255,0.35), transparent 55%),
        radial-gradient(circle at 50% 120%, rgba(255,215,0,0.35), transparent 60%),
        conic-gradient(
          #1b1b1b 0deg 45deg,
          #6d4c41 45deg 90deg,
          #1b1b1b 90deg 135deg,
          #6d4c41 135deg 180deg,
          #1b1b1b 180deg 225deg,
          #6d4c41 225deg 270deg,
          #1b1b1b 270deg 315deg,
          #6d4c41 315deg 360deg
        );
      box-shadow: 0 6px 16px rgba(0,0,0,0.4), 0 0 0 4px #000, 0 0 0 8px #fbc02d;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pointer {
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 26px solid #fdd835;
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6));
    }

    .ruleta-center {
      width: 78px;
      height: 78px;
      border-radius: 50%;
      background: radial-gradient(circle, #fffde7 0%, #fbc02d 55%, #f57f17 100%);
      border: 3px solid #3e2723;
      box-shadow: 0 0 10px rgba(255,214,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-center {
      width: 52px;
      height: 52px;
      background: #ffffff;
      color: #000;
      font-size: 26px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }

    .ruleta-segment-icon {
      position: absolute;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.35);
    }

    .seg-1 { top: 10px; left: 50%; transform: translateX(-50%); }
    .seg-2 { top: 32px; right: 26px; }
    .seg-3 { top: 50%; right: 4px; transform: translateY(-50%); }
    .seg-4 { bottom: 32px; right: 26px; }
    .seg-5 { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .seg-6 { bottom: 32px; left: 26px; }
    .seg-7 { top: 50%; left: 4px; transform: translateY(-50%); }
    .seg-8 { top: 32px; left: 26px; }

    .wheel-coin-yellow {
      background: radial-gradient(circle, #fff9c4 0%, #ffeb3b 55%, #fbc02d 100%);
      border: 2px solid #795548;
      color: #5d4037;
    }

    .wheel-coin-blue {
      background: radial-gradient(circle, #e3f2fd 0%, #64b5f6 55%, #1e88e5 100%);
      border: 2px solid #0d47a1;
      color: #0d47a1;
    }

    .wheel-percent {
      background: radial-gradient(circle, #f3e5f5 0%, #ba68c8 50%, #7b1fa2 100%);
      border: 2px solid #4a148c;
      color: #fff;
      font-size: 16px;
    }

    .btn-girar {
      background: var(--accent);
      color: #fff;
      padding: 12px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      max-width: 280px;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .btn-girar:disabled { opacity: 0.6; cursor: not-allowed; }

    #resultado {
      margin-top: 4px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
    }

    .tiradas-info {
      margin-top: 6px;
      text-align: center;
      font-size: 14px;
      color: var(--text-soft);
    }

    .cooldown-info {
      margin-top: 4px;
      text-align: center;
      font-size: 13px;
      color: var(--accent);
      font-weight: bold;
    }

    /* LADO DERECHO: OFERTAS */

    .offers-panel-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--accent);
    }

    .offers-panel-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .offer-item {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 8px;
      padding: 8px 6px;
      border-radius: 9px;
      background: #fff5f5;
      border: 1px dashed #ffcdd2;
      margin-bottom: 6px;
      align-items: center;
    }

    .offer-img {
      width: 72px;
      height: 72px;
      border-radius: 8px;
      object-fit: cover;
      background: #eee;
    }

    .offer-text-title {
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .offer-text-price {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .offer-text-price span.old {
      text-decoration: line-through;
      color: #999;
      font-size: 12px;
    }

    .offer-timer {
      font-size: 11px;
      color: var(--accent);
      font-weight: bold;
    }

    /* CATEGOR√çAS */

    .categorias {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin: 0 20px 30px;
    }

    .categoria {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      background: #e0e0e0;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .categoria:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }

    .cat-img {
      position: relative;
      height: 110px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .cat-img-comodities {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/commodities.jpg");
    }

    .cat-img-insumos {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.35), rgba(0,0,0,0.0)),
        url("img/insumos.jpg");
    }

    .cat-img-cell {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.35), rgba(0,0,0,0.0)),
        url("img/cell.jpg");
    }

    .cat-img-electronica {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.35), rgba(0,0,0,0.0)),
        url("img/tv.jpg");
    }

    .cat-img-ropa {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.35), rgba(0,0,0,0.0)),
        url("img/ropa.jpg");
    }

    .cat-img-experiencias {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.35), rgba(0,0,0,0.0)),
        url("img/kart.jpg");
    }

    .cat-img-imperdibles {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/imperdibles.jpg");
    }

    .cat-img-hoteles {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/hoteles.jpg");
    }

    .cat-img-muebles {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/muebles.jpg");
    }

    .cat-img-deportes {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/deportes.jpg");
    }

    .cat-img-comida {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/comida.jpg");
    }

    .cat-img-electro {
      background-image:
        linear-gradient(120deg, rgba(0,0,0,0.45), rgba(0,0,0,0.0)),
        url("img/electrodomesticos.jpg");
    }

    .cat-discount-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #7b1fa2;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      text-align: center;
      animation: discount-pulse 1.4s ease-in-out infinite;
    }

    .cat-discount-badge .off { font-size: 12px; }

    @keyframes discount-pulse {
      0%   { transform: scale(1);   box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
      50%  { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.55); }
      100% { transform: scale(1);   box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    }

    .cat-bottom {
      background: #3c3c3c;
      padding: 8px 10px;
      color: #fff;
      font-size: 13px;
      text-align: center;
    }

    .cat-logo-comodity {
      position: absolute;
      left: 8px;
      bottom: 8px;
      width: 30px;
      height: 30px;
      background: #fff;
      color: #000;
      font-weight: bold;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      clip-path: polygon(15% 0%, 90% 10%, 100% 60%, 55% 100%, 0% 65%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* OVERLAYS POPUPS */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .popup {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 20px 16px;
      max-width: 340px;
      width: calc(100% - 40px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
    }

    .reward-icon {
      font-size: 40px;
      margin-bottom: 6px;
    }

    .reward-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .reward-desc {
      font-size: 14px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .reward-company {
      font-size: 13px;
      margin-bottom: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .company-logo {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 11px;
      font-weight: bold;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .company-pizza  { background: linear-gradient(135deg, #ffb300, #f57c00); }
    .company-mueble { background: linear-gradient(135deg, #3949ab, #1e88e5); }
    .company-ferre  { background: linear-gradient(135deg, #00897b, #43a047); }

    .reward-coins {
      position: relative;
      height: 110px;
      margin-bottom: 10px;
      pointer-events: none;
      overflow: visible;
    }

    .coin {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 6px 14px rgba(0,0,0,0.45);
      animation: coin-rain 0.9s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
      opacity: 0;
      transform-origin: center;
    }

    .coin-yellow {
      background: radial-gradient(circle, #fffde7 0%, #ffeb3b 45%, #fbc02d 100%);
      color: #6d4c41;
    }

    .coin-blue {
      background: radial-gradient(circle, #e3f2fd 0%, #64b5f6 45%, #1e88e5 100%);
      color: #0d47a1;
    }

    .coin-neutral {
      background: radial-gradient(circle, #fafafa 0%, #eeeeee 45%, #bdbdbd 100%);
      color: #424242;
    }

    .coin::after {
      content: "";
      position: absolute;
      width: 60%;
      height: 60%;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.9), transparent 60%);
      pointer-events: none;
    }

    @keyframes coin-rain {
      0% {
        transform: translate(var(--coin-x, 0), -40px) scale(0.6) rotate(0deg);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      70% {
        transform: translate(var(--coin-x, 0), 40px) scale(1) rotate(260deg);
        opacity: 1;
      }
      100% {
        transform: translate(var(--coin-x, 0), 65px) scale(0.9) rotate(360deg);
        opacity: 0;
      }
    }

    .reward-close,
    .popup-close {
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 7px 14px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 6px;
    }

    /* popup cupones */

    .popup-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 6px;
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .popup-subtitle {
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .coupons-list {
      max-height: 220px;
      overflow-y: auto;
      text-align: left;
      margin-bottom: 10px;
    }

    .coupon-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 6px;
      border-radius: 10px;
      background: rgba(0,0,0,0.02);
      margin-bottom: 6px;
    }

    .coupon-logo {
      width: 32px;
      height: 22px;
      border-radius: 6px;
      border: 2px dashed rgba(0,0,0,0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      background: #fff8e1;
    }

    .coupon-text { display: flex; flex-direction: column; gap: 1px; }

    .coupon-brand { font-size: 13px; font-weight: bold; }

    .coupon-desc { font-size: 12px; color: var(--text-soft); }

    .coupon-empty { font-size: 13px; color: var(--text-soft); margin-bottom: 12px; }

    /* Popup datos personales */

    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      text-align: left;
      font-size: 13px;
    }

    .profile-form label {
      display: block;
    }

    .profile-form input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 2px;
      font-size: 13px;
    }

    /* CELULARES - PANTALLA INTERNA */

    .back-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 14px 20px 4px;
      font-size: 14px;
      color: var(--text-soft);
    }

    .back-link {
      background: none;
      border: none;
      color: var(--accent);
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      padding: 4px 0;
    }

    .cellphones-title {
      margin: 4px 20px 12px;
      font-size: 20px;
      font-weight: bold;
    }

    .cellphones-subtitle {
      margin: 0 20px 14px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .cellphones-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin: 0 20px 26px;
    }

    .cell-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.14);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }

    .cell-img-wrap {
      background: #fafafa;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell-img-wrap img {
      max-width: 100%;
      max-height: 120px;
      object-fit: contain;
      display: block;
    }

    .cell-body {
      padding: 8px 10px 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cell-name {
      font-weight: bold;
      min-height: 34px;
    }

    .cell-prices {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .cell-price-old {
      font-size: 12px;
      color: #888;
      text-decoration: line-through;
    }

    .cell-price-now {
      font-size: 15px;
      font-weight: bold;
      color: #2e7d32;
    }

    .cell-discount-pill {
      margin-top: 2px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #fff;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      padding: 3px 7px;
      border-radius: 999px;
    }

    .cell-timer {
      margin-top: 4px;
      font-size: 11px;
      color: var(--accent);
      font-weight: bold;
    }

    .cell-detail-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .cell-detail-img {
      max-width: 90%;
      max-height: 180px;
      object-fit: contain;
      margin-bottom: 10px;
    }

    .cell-detail-text {
      text-align: left;
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .cell-detail-text strong {
      color: var(--text-main);
    }

    /* PANTALLA INVITAR AMIGOS */

    .invite-screen-title {
      margin: 4px 20px 10px;
      font-size: 20px;
      font-weight: bold;
    }

    .invite-screen-text {
      margin: 0 20px 10px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .invite-card {
      margin: 0 20px 20px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.14);
      padding: 14px 14px 16px;
      font-size: 13px;
    }

    .invite-card h3 {
      margin: 0 0 6px;
      font-size: 15px;
    }

    .invite-link-box {
      margin-top: 8px;
      padding: 8px 10px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px dashed #ccc;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      word-break: break-all;
    }

    .invite-link-text {
      font-size: 12px;
      color: #333;
      flex: 1;
    }

    .btn-copy {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }

    /* ANIMACI√ìN RULETA */

    @keyframes girar {
      from { transform: rotate(0deg); }
      to   { transform: rotate(1440deg); }
    }

    .spin { animation: girar 1.5s ease-out; }

    /* RESPONSIVE */

    @media (min-width: 768px) {
      header { padding-left: 24px; padding-right: 24px; }

      .ruleta-container {
        max-width: 980px;
        margin: 24px auto;
      }

      .ruleta-layout {
        flex-direction: row;
        align-items: stretch;
      }

      .ruleta-side {
        width: 26%;
      }

      .ruleta-center-wrapper {
        width: 48%;
        border-radius: 12px;
        padding: 6px 10px 0;
      }

      .categorias {
        max-width: 900px;
        margin: 0 auto 40px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 14px;
      }

      .categoria {
        transform: scale(1.1);
      }

      .cat-img {
        height: 135px;
      }

      .cellphones-grid {
        max-width: 900px;
        margin: 0 auto 26px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">C</div>
    </div>
    <div class="login-title">Ingres√° a Comodity</div>
    <div class="login-subtitle">Gir√° la ruleta y acumul√° saldo y cupones para tus compras.</div>

    <form id="login-form" class="login-form">
      <div id="login-name-group">
        <label for="login-name">Nombre</label>
        <input id="login-name" type="text" placeholder="Ej: Javier Araujo" />
      </div>
      <div>
        <label for="login-email">Email</label>
        <input id="login-email" type="email" placeholder="tucorreo@example.com" required />
      </div>
      <div>
        <label for="login-password">Contrase√±a</label>
        <input id="login-password" type="password" placeholder="‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè" required />
      </div>
      <button type="submit" class="login-button" id="login-submit-btn">Entrar</button>
      <button
        type="button"
        class="login-button"
        style="margin-top:10px;background:#4285F4"
        onclick="loginWithGoogle()">
        Continuar con Google
      </button>
    </form>

    <div class="login-note">
      <span id="login-mode-message">¬øNo ten√©s cuenta?</span>
      <button type="button" id="toggle-login-mode" class="link-like">Crear cuenta</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="header-left">
      <div class="user-avatar" id="user-avatar">üë§</div>
      <div class="user-text">
        <div id="user-name" class="user-name">Invitado</div>
        <div class="user-balances">
          <div class="badge-balance">
            <span class="icon-badge">$</span>
            Libre: $<span id="saldo-libre" class="value">0</span>
          </div>
          <div class="badge-balance">
            <span class="icon-badge">‚ö°</span>
            Lightning: $<span id="saldo-light" class="value">0</span>
          </div>
          <div class="badge-balance badge-coupons" onclick="openCouponsPopup()">
            <span class="icon-badge">üéüÔ∏è</span>
            Cupones: <span id="cupones-count" class="value">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="header-right">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="logo-big">C</div>
        <div class="title-text">Comodity</div>
      </div>
    </div>
  </header>

  <!-- Men√∫ usuario -->
  <div id="user-menu" class="user-menu">
    <div class="user-menu-item" onclick="openProfileOverlay()">Datos personales</div>
    <div class="user-menu-item" onclick="logout()">Cerrar sesi√≥n</div>
  </div>

  <main>
    <!-- HOME -->
    <div id="home-screen" class="screen active">
      <div class="ruleta-container">
        <div class="ruleta-title">Gir√° la ruleta y gan√° beneficios para tus compras</div>

        <div class="ruleta-layout">
          <!-- IZQUIERDA: SORTEO + INVITAR -->
          <div class="ruleta-side">
            <div class="ruleta-side-title">Pr√≥ximo sorteo</div>
            <div class="ruleta-side-subtitle">Smart TV TCL 50"</div>
            <img src="img/banner_tv_tcl.jpg" alt="Smart TV TCL 50" class="sorteo-img">
            <div class="sorteo-date">
              Se sortea el <span id="sorteo-date-text"></span>.
            </div>

            <div class="invite-box">
              <div class="invite-title">Invit√° a un amigo</div>
              <div class="invite-text">
                Invit√° amigos a Comodity y <strong>ambos ganan 8 tiradas gratis</strong>
                para la ruleta.
              </div>
              <button class="btn-small" onclick="goToInviteScreen()">Invitar</button>
            </div>
          </div>

          <!-- CENTRO: RULETA -->
          <div class="ruleta-center-wrapper">
            <div class="ruleta-wrapper">
              <div class="ruleta" id="ruleta">
                <div class="pointer"></div>
                <div class="ruleta-center">
                  <div class="logo-center">C</div>
                </div>

                <div class="ruleta-segment-icon wheel-coin-yellow seg-1">$</div>
                <div class="ruleta-segment-icon wheel-percent     seg-2">%</div>
                <div class="ruleta-segment-icon wheel-coin-blue   seg-3">$</div>
                <div class="ruleta-segment-icon wheel-coin-yellow seg-4">$</div>
                <div class="ruleta-segment-icon wheel-percent     seg-5">%</div>
                <div class="ruleta-segment-icon wheel-coin-blue   seg-6">$</div>
                <div class="ruleta-segment-icon wheel-coin-yellow seg-7">$</div>
                <div class="ruleta-segment-icon wheel-coin-blue   seg-8">$</div>
              </div>

              <button class="btn-girar" id="btn-girar" onclick="girarRuleta()">
                Girar ruleta
              </button>
            </div>
            <p id="resultado"></p>
            <p id="tiradas-info" class="tiradas-info">4 tiradas restantes</p>
            <p id="cooldown-info" class="cooldown-info" style="display:none;">
              Pr√≥xima recarga en <span id="cooldown-seconds">12:00:00</span>
            </p>
          </div>

          <!-- DERECHA: OFERTAS CON TIMER -->
          <div class="ruleta-side">
            <div class="offers-panel-title">Ofertas exclusivas de Comodity</div>
            <div class="offers-panel-subtitle">Aprovechalas antes de que se acaben:</div>

            <div class="offer-item">
              <img src="img/offer_auriculares.jpg" alt="Auriculares inal√°mbricos" class="offer-img">
              <div>
                <div class="offer-text-title">Auriculares inal√°mbricos</div>
                <div class="offer-text-price">
                  $179 <span class="old">$320</span>
                </div>
                <div class="offer-timer" data-offer-id="auris"></div>
              </div>
            </div>

            <div class="offer-item">
              <img src="img/offer_fiter.jpg" alt="Membres√≠a Fiter 3 meses" class="offer-img">
              <div>
                <div class="offer-text-title">Membres√≠a Fiter 3 meses</div>
                <div class="offer-text-price">
                  $1.290/mes <span class="old">$1.900/mes</span>
                </div>
                <div class="offer-timer" data-offer-id="fiter"></div>
              </div>
            </div>

            <div class="offer-item">
              <img src="img/offer_zapatillas.jpg" alt="Zapatillas para correr" class="offer-img">
              <div>
                <div class="offer-text-title">Zapatillas para correr</div>
                <div class="offer-text-price">
                  $899 <span class="old">$2.000</span>
                </div>
                <div class="offer-timer" data-offer-id="zapatillas"></div>
              </div>
            </div>

            <div class="offer-item">
              <img src="img/offer_tcl_50.jpg" alt="Smart TV TCL 50&quot;" class="offer-img">
              <div>
                <div class="offer-text-title">Smart TV TCL 50"</div>
                <div class="offer-text-price">
                  U$S 325 <span class="old">U$S 480</span>
                </div>
                <div class="offer-timer" data-offer-id="tv"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CATEGOR√çAS -->
      <div class="categorias">
        <div class="categoria" data-cat="commodities">
          <div class="cat-img cat-img-comodities">
            <div class="cat-discount-badge">
              hasta<br><span class="off">50% OFF</span>
            </div>
            <div class="cat-logo-comodity">C</div>
          </div>
          <div class="cat-bottom"><span>Commodities</span></div>
        </div>

        <div class="categoria" data-cat="insumos">
          <div class="cat-img cat-img-insumos">
            <div class="cat-discount-badge">
              hasta<br><span class="off">35% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Insumos constructivos</span></div>
        </div>

        <div class="categoria" data-cat="celulares">
          <div class="cat-img cat-img-cell">
            <div class="cat-discount-badge">
              hasta<br><span class="off">40% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Celulares</span></div>
        </div>

        <div class="categoria" data-cat="electronica">
          <div class="cat-img cat-img-electronica">
            <div class="cat-discount-badge">
              hasta<br><span class="off">45% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Electr√≥nica, audio y video</span></div>
        </div>

        <div class="categoria" data-cat="ropa">
          <div class="cat-img cat-img-ropa">
            <div class="cat-discount-badge">
              hasta<br><span class="off">30% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Ropa</span></div>
        </div>

        <div class="categoria" data-cat="experiencias">
          <div class="cat-img cat-img-experiencias">
            <div class="cat-discount-badge">
              hasta<br><span class="off">60% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Experiencias</span></div>
        </div>

        <div class="categoria" data-cat="imperdibles">
          <div class="cat-img cat-img-imperdibles">
            <div class="cat-discount-badge">
              hasta<br><span class="off">70% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Imperdibles &lt; $1000</span></div>
        </div>

        <div class="categoria" data-cat="hoteles">
          <div class="cat-img cat-img-hoteles">
            <div class="cat-discount-badge">
              hasta<br><span class="off">55% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Hoteles y viajes</span></div>
        </div>

        <div class="categoria" data-cat="muebles">
          <div class="cat-img cat-img-muebles">
            <div class="cat-discount-badge">
              hasta<br><span class="off">45% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Muebles y hogar</span></div>
        </div>

        <div class="categoria" data-cat="deportes">
          <div class="cat-img cat-img-deportes">
            <div class="cat-discount-badge">
              hasta<br><span class="off">40% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Deportes y fitness</span></div>
        </div>

        <div class="categoria" data-cat="comida">
          <div class="cat-img cat-img-comida">
            <div class="cat-discount-badge">
              hasta<br><span class="off">35% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Comida</span></div>
        </div>

        <div class="categoria" data-cat="electro">
          <div class="cat-img cat-img-electro">
            <div class="cat-discount-badge">
              hasta<br><span class="off">40% OFF</span>
            </div>
          </div>
          <div class="cat-bottom"><span>Electrodom√©sticos</span></div>
        </div>
      </div>
    </div>

    <!-- PANTALLA CELULARES -->
    <div id="cellphones-screen" class="screen">
      <div class="back-bar">
        <button class="back-link" onclick="goToHome()">
          ‚Üê Volver
        </button>
      </div>
      <div class="cellphones-title">Celulares en oferta</div>
      <div class="cellphones-subtitle">
        Ofertas con 20% OFF por tiempo limitado. El descuento termina al final del d√≠a.
      </div>

      <div class="cellphones-grid" id="cellphones-grid"></div>
    </div>

    <!-- PANTALLA INVITAR AMIGOS -->
    <div id="invite-screen" class="screen">
      <div class="back-bar">
        <button class="back-link" onclick="goToHome()">
          ‚Üê Volver
        </button>
      </div>

      <div class="invite-screen-title">Invit√° amigos y ganen 8 tiradas</div>
      <div class="invite-screen-text">
        Por cada amigo que se registre con tu link y haga su primera compra o uso de beneficio,
        <strong>vos y tu amigo reciben 8 tiradas extra</strong> para la ruleta.
      </div>

      <div class="invite-card">
        <h3>¬øC√≥mo funciona?</h3>
        <ol style="margin:0 0 8px 18px;padding:0;font-size:13px;">
          <li>Copi√° tu link de invitaci√≥n.</li>
          <li>Compartilo por WhatsApp, redes o donde quieras.</li>
          <li>Cuando tu amigo se registre y use Comodity, se acreditan 8 tiradas para cada uno.</li>
        </ol>

        <div class="invite-link-box">
          <div id="referral-link" class="invite-link-text">
            Generando link...
          </div>
          <button class="btn-copy" onclick="copyReferralLink()">Copiar</button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- POPUP RECOMPENSAS -->
<div id="reward-overlay" class="overlay">
  <div class="popup">
    <div id="reward-icon" class="reward-icon">üí∞</div>
    <div id="reward-title" class="reward-title">¬°Premio!</div>
    <div id="reward-desc" class="reward-desc">Ganaste algo.</div>
    <div id="reward-company" class="reward-company" style="display:none;">
      <span id="reward-company-logo" class="company-logo">BR</span>
      <span id="reward-company-text"></span>
    </div>
    <div id="reward-coins" class="reward-coins"></div>
    <button class="reward-close" onclick="closeRewardPopup()">Aceptar</button>
  </div>
</div>

<!-- POPUP CUPONES -->
<div id="coupons-overlay" class="overlay">
  <div class="popup">
    <div class="popup-title">
      <span>üéüÔ∏è</span><span>Mis cupones</span>
    </div>
    <div class="popup-subtitle">
      Cupones de descuento que ganaste en la ruleta.
    </div>
    <div id="coupons-empty" class="coupon-empty">
      Todav√≠a no ten√©s cupones. Prob√° suerte girando la ruleta.
    </div>
    <div id="coupons-list" class="coupons-list"></div>
    <button class="popup-close" onclick="closeCouponsPopup()">Cerrar</button>
  </div>
</div>

<!-- POPUP DATOS PERSONALES -->
<div id="profile-overlay" class="overlay">
  <div class="popup">
    <div class="reward-title">Datos personales</div>
    <form id="profile-form" class="profile-form">
      <label>Nombre completo
        <input type="text" id="profile-name" />
      </label>
      <label>Direcci√≥n
        <input type="text" id="profile-address" />
      </label>
      <label>Fecha de nacimiento
        <input type="date" id="profile-birthdate" />
      </label>
      <label>Tel√©fono
        <input type="tel" id="profile-phone" />
      </label>
      <button type="submit" class="reward-close">Guardar</button>
      <button type="button" class="popup-close" onclick="closeProfileOverlay()">Cancelar</button>
    </form>
  </div>
</div>

<!-- POPUP DETALLE CELULAR -->
<div id="cell-detail-overlay" class="overlay">
  <div class="popup">
    <div id="cell-detail-title" class="cell-detail-title"></div>
    <img id="cell-detail-img" class="cell-detail-img" src="" alt="">
    <div id="cell-detail-prices" class="cell-detail-text"></div>
    <div id="cell-detail-extra" class="cell-detail-text"></div>
    <button class="popup-close" onclick="closeCellDetail()">Cerrar</button>
  </div>
</div>

<script>
  let saldoLibre = 0;
  let saldoLight = 0;
  let cupones = [];
  let tiradasRestantes = 4;
  let countdownTimer = null;
  let countdownSecondsRemaining = 0;
  let isSpinning = false;
  let audioCtx;
  let currentUser = null;
  let currentUserName = null;

  let profileData = {
    nombre: "",
    direccion: "",
    fechaNacimiento: "",
    telefono: ""
  };

  let isRegisterMode = false;

  let cellIntervals = [];
  let offersInterval = null;
  let lastReferralLink = "";

  const outcomes = [
    { label: "Sin premio, suerte a la pr√≥xima üò¢", type: "none", prob: 0.30 },
    { label: "$25 saldo libre", type: "saldoLibre", amount: 25, prob: 0.20 },
    { label: "$150 saldo libre", type: "saldoLibreJackpot", amount: 150, prob: 0.10 },
    { label: "30% de descuento en PizzaRocket", type: "descuentoPizza", prob: 0.20 },
    { label: "$80 saldo lightning para gastar en MuebleBox", type: "saldoLightMueble", amount: 80, prob: 0.10 },
    { label: "$20 saldo lightning para gastar en FerreBuceo", amount: 20, type: "saldoLightFerre", prob: 0.10 }
  ];

  /* LOGIN / USUARIO */

  function applyUserName() {
    const el = document.getElementById("user-name");
    if (el && currentUserName) el.textContent = currentUserName;
  }

  function getUserKey(suffix) {
    if (!currentUser) return null;
    return "comodity_" + suffix + "_" + currentUser.uid;
  }

  function saveStateForUser() {
    const key = getUserKey("state");
    if (!key) return;
    const state = { saldoLibre, saldoLight, cupones, tiradasRestantes };
    localStorage.setItem(key, JSON.stringify(state));
  }

  function saveProfileForUser() {
    const key = getUserKey("profile");
    if (!key) return;
    const data = {
      nombre: currentUserName,
      direccion: profileData.direccion || "",
      fechaNacimiento: profileData.fechaNacimiento || "",
      telefono: profileData.telefono || ""
    };
    localStorage.setItem(key, JSON.stringify(data));
  }

  function loadUserData() {
    if (!currentUser) return;

    const stateKey = getUserKey("state");
    saldoLibre = 0;
    saldoLight = 0;
    cupones = [];
    tiradasRestantes = 4;

    if (stateKey) {
      const raw = localStorage.getItem(stateKey);
      if (raw) {
        try {
          const s = JSON.parse(raw);
          if (typeof s.saldoLibre === "number") saldoLibre = s.saldoLibre;
          if (typeof s.saldoLight === "number") saldoLight = s.saldoLight;
          if (Array.isArray(s.cupones)) cupones = s.cupones;
          if (typeof s.tiradasRestantes === "number") tiradasRestantes = s.tiradasRestantes;
        } catch (e) {}
      }
    }

    const profileKey = getUserKey("profile");
    profileData = { nombre: "", direccion: "", fechaNacimiento: "", telefono: "" };
    if (profileKey) {
      const rawP = localStorage.getItem(profileKey);
      if (rawP) {
        try {
          const p = JSON.parse(rawP);
          profileData.nombre = p.nombre || "";
          profileData.direccion = p.direccion || "";
          profileData.fechaNacimiento = p.fechaNacimiento || "";
          profileData.telefono = p.telefono || "";
          if (profileData.nombre) currentUserName = profileData.nombre;
        } catch (e) {}
      }
    }

    applyUserName();
    actualizarSaldos();
    actualizarCuponesCount();
    actualizarTiradas();
    updateReferralLink();
  }

  function handleUserLoggedIn(user, nameOverride) {
    currentUser = user;
    currentUserName = nameOverride || user.displayName || user.email;
    applyUserName();

    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app").style.display = "block";

    loadUserData();
  }

  function handleLoggedOut() {
    currentUser = null;
    currentUserName = null;
    saldoLibre = 0;
    saldoLight = 0;
    cupones = [];
    tiradasRestantes = 4;
    document.getElementById("app").style.display = "none";
    document.getElementById("login-screen").style.display = "flex";
  }

  auth.onAuthStateChanged(function(user) {
    if (user) {
      if (currentUser && currentUser.uid === user.uid) return;
      handleUserLoggedIn(user);
    } else {
      handleLoggedOut();
    }
  });

  function toggleLoginMode() {
    isRegisterMode = !isRegisterMode;
    const nameGroup = document.getElementById("login-name-group");
    const submitBtn = document.getElementById("login-submit-btn");
    const msg = document.getElementById("login-mode-message");
    const toggleBtn = document.getElementById("toggle-login-mode");

    if (isRegisterMode) {
      nameGroup.style.display = "block";
      submitBtn.textContent = "Crear cuenta y entrar";
      msg.textContent = "¬øYa ten√©s cuenta?";
      toggleBtn.textContent = "Iniciar sesi√≥n";
    } else {
      nameGroup.style.display = "none";
      submitBtn.textContent = "Entrar";
      msg.textContent = "¬øNo ten√©s cuenta?";
      toggleBtn.textContent = "Crear cuenta";
    }
  }

  document.getElementById("toggle-login-mode").addEventListener("click", toggleLoginMode);

  document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const name  = document.getElementById("login-name").value.trim();
    const email = document.getElementById("login-email").value.trim();
    const pass  = document.getElementById("login-password").value.trim();

    if (isRegisterMode) {
      if (!name || !email || !pass) {
        alert("Complet√° nombre, email y contrase√±a para crear la cuenta.");
        return;
      }
      try {
        const credNew = await auth.createUserWithEmailAndPassword(email, pass);
        await credNew.user.updateProfile({ displayName: name });
        handleUserLoggedIn(credNew.user, name);
        profileData.nombre = name;
        saveProfileForUser();
      } catch (err2) {
        alert("Error al crear usuario: " + err2.message);
      }
    } else {
      if (!email || !pass) {
        alert("Complet√° email y contrase√±a.");
        return;
      }
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        handleUserLoggedIn(cred.user);
      } catch (err) {
        if (err.code === "auth/user-not-found") {
          alert("Usuario no encontrado. Cambi√° a 'Crear cuenta' para registrarte.");
        } else if (err.code === "auth/wrong-password") {
          alert("Contrase√±a incorrecta.");
        } else {
          alert("Error al iniciar sesi√≥n: " + err.message);
        }
      }
    }
  });

  async function loginWithGoogle() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      handleUserLoggedIn(user, user.displayName || user.email);
    } catch (err) {
      console.error(err);
      alert("Error al iniciar sesi√≥n con Google: " + err.message);
    }
  }

  async function logout() {
    try {
      await auth.signOut();
      document.getElementById("user-menu").style.display = "none";
    } catch (e) {
      console.error(e);
    }
  }

  /* SONIDOS */

  function getAudioCtx() {
    if (!window.AudioContext && !window.webkitAudioContext) return null;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    return audioCtx;
  }

  function playSpinSoundSequence() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    for (let i = 0; i < 7; i++) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "triangle";
      const start = now + i * 0.08;
      const end   = start + 0.07;
      const f1 = 600 + i * 80;
      const f2 = f1 + 120;
      osc.frequency.setValueAtTime(f1, start);
      osc.frequency.linearRampToValueAtTime(f2, end);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.28, start + 0.02);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    }
  }

  function playWinSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    [523.25, 659.25, 783.99].forEach((f, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const start = now + i * 0.03;
      const end   = start + 0.35;
      osc.type = "sine";
      osc.frequency.setValueAtTime(f, start);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.4, start + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    });
  }

  function playJackpotSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    [523.25, 659.25, 783.99, 1046.5].forEach((f, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const start = now + i * 0.12;
      const end   = start + 0.4;
      osc.type = "square";
      osc.frequency.setValueAtTime(f, start);
      osc.frequency.linearRampToValueAtTime(f + 60, end);
      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.45, start + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, end);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(start); osc.stop(end);
    });
  }

  function playLoseSound() {
    const ctx = getAudioCtx(); if (!ctx) return;
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(440, now);
    osc.frequency.linearRampToValueAtTime(220, now + 0.5);
    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.3, now + 0.05);
    gain.gain.linearRampToValueAtTime(0.0, now + 0.5);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(now); osc.stop(now + 0.5);
  }

  function playCoinRainSound() {
    const ctx = getAudioCtx();
    if (!ctx) return;

    const now = ctx.currentTime;

    for (let i = 0; i < 8; i++) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      const start = now + i * 0.05;
      const end   = start + 0.25;

      const baseFreq = 900 + Math.random() * 600;
      osc.type = "triangle";
      osc.frequency.setValueAtTime(baseFreq, start);
      osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.4, end);

      gain.gain.setValueAtTime(0.0, start);
      gain.gain.linearRampToValueAtTime(0.45, start + 0.03);
      gain.gain.exponentialRampToValueAtTime(0.02, end);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(start);
      osc.stop(end);
    }
  }

  function getRandomOutcomeWeighted() {
    const r = Math.random();
    let acc = 0;
    for (const o of outcomes) {
      acc += o.prob;
      if (r <= acc) return o;
    }
    return outcomes[outcomes.length - 1];
  }

  function actualizarSaldos() {
    document.getElementById("saldo-libre").textContent  = saldoLibre;
    document.getElementById("saldo-light").textContent  = saldoLight;
    saveStateForUser();
  }
  function actualizarCuponesCount() {
    document.getElementById("cupones-count").textContent = cupones.length;
    saveStateForUser();
  }
  function actualizarTiradas() {
    document.getElementById("tiradas-info").textContent =
      tiradasRestantes + " tiradas restantes";
    saveStateForUser();
  }

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function startCountdown12h() {
    const info  = document.getElementById("cooldown-info");
    const label = document.getElementById("cooldown-seconds");
    if (countdownTimer) clearInterval(countdownTimer);
    countdownSecondsRemaining = 12 * 60 * 60;
    info.style.display = "block";
    label.textContent = formatTime(countdownSecondsRemaining);
    countdownTimer = setInterval(() => {
      countdownSecondsRemaining--;
      if (countdownSecondsRemaining < 0) countdownSecondsRemaining = 0;
      label.textContent = formatTime(countdownSecondsRemaining);
      if (countdownSecondsRemaining <= 0) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
    }, 1000);
  }

  function stopCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = null;
    document.getElementById("cooldown-info").style.display = "none";
  }

  function showRewardPopup(kind, outcome) {
    const overlay      = document.getElementById("reward-overlay");
    const iconEl       = document.getElementById("reward-icon");
    const titleEl      = document.getElementById("reward-title");
    const descEl       = document.getElementById("reward-desc");
    const coinsEl      = document.getElementById("reward-coins");
    const companyWrap  = document.getElementById("reward-company");
    const companyLogo  = document.getElementById("reward-company-logo");
    const companyText  = document.getElementById("reward-company-text");

    let icon = "üí∞";
    let title = "¬°Premio!";
    let coinClass = "coin-yellow";
    let showCompany = false;

    if (kind === "libre") {
      icon = "üí∞"; title = "¬°Saldo libre ganado!"; coinClass="coin-yellow";
    } else if (kind === "jackpot") {
      icon = "üèÜ"; title = "¬°JACKPOT de saldo libre!"; coinClass="coin-yellow";
    } else if (kind === "descuento") {
      icon = "ÔºÖ"; title = "¬°Descuento desbloqueado!"; coinClass="coin-neutral"; showCompany = true;
      companyLogo.textContent = "PR";
      companyLogo.className = "company-logo company-pizza";
      companyText.textContent = "PizzaRocket";
    } else if (kind === "lightning-mueble") {
      icon = "‚ö°"; title = "Saldo lightning MuebleBox"; coinClass="coin-blue"; showCompany = true;
      companyLogo.textContent = "MB";
      companyLogo.className = "company-logo company-mueble";
      companyText.textContent = "MuebleBox";
    } else if (kind === "lightning-ferre") {
      icon = "‚ö°"; title = "Saldo lightning FerreBuceo"; coinClass="coin-blue"; showCompany = true;
      companyLogo.textContent = "FB";
      companyLogo.className = "company-logo company-ferre";
      companyText.textContent = "FerreBuceo";
    }

    iconEl.textContent = icon;
    titleEl.textContent = title;
    descEl.textContent  = outcome.label;
    companyWrap.style.display = showCompany ? "inline-flex" : "none";

    coinsEl.innerHTML = "";
    const coinCount = 10;

    for (let i = 0; i < coinCount; i++) {
      const c = document.createElement("div");
      c.className = "coin " + coinClass;

      const offsetX = (Math.random() - 0.5) * 120;
      c.style.setProperty("--coin-x", offsetX + "px");

      const delay = Math.random() * 0.25;
      c.style.animationDelay = delay + "s";

      c.textContent = kind === "descuento"
        ? "%"
        : (kind.startsWith("lightning") ? "‚ö°" : "$");

      coinsEl.appendChild(c);
    }

    overlay.style.display = "flex";

    if (
      kind === "libre" ||
      kind === "jackpot" ||
      kind === "lightning-mueble" ||
      kind === "lightning-ferre"
    ) {
      playCoinRainSound();
    }
  }

  function closeRewardPopup() {
    document.getElementById("reward-overlay").style.display = "none";
  }

  function agregarCupon(coupon) {
    cupones.push(coupon);
    actualizarCuponesCount();
  }

  function openCouponsPopup() {
    const overlay = document.getElementById("coupons-overlay");
    const listEl  = document.getElementById("coupons-list");
    const emptyEl = document.getElementById("coupons-empty");
    listEl.innerHTML = "";
    if (cupones.length === 0) {
      emptyEl.style.display = "block";
    } else {
      emptyEl.style.display = "none";
      cupones.forEach(c => {
        const item = document.createElement("div");
        item.className = "coupon-item";
        item.innerHTML = `
          <div class="coupon-logo">%</div>
          <div class="coupon-text">
            <div class="coupon-brand">${c.brand}</div>
            <div class="coupon-desc">${c.description}</div>
          </div>`;
        listEl.appendChild(item);
      });
    }
    overlay.style.display = "flex";
  }

  function closeCouponsPopup() {
    document.getElementById("coupons-overlay").style.display = "none";
  }

  function girarRuleta() {
    const ruleta    = document.getElementById("ruleta");
    const resultado = document.getElementById("resultado");
    const btn       = document.getElementById("btn-girar");
    if (isSpinning) return;
    isSpinning = true;

    if (tiradasRestantes <= 0) {
      tiradasRestantes = 4;
      stopCountdown();
    }
    tiradasRestantes--;
    actualizarTiradas();

    resultado.innerText = "Girando...";
    btn.disabled = true;

    ruleta.classList.remove("spin");
    void ruleta.offsetWidth;
    ruleta.classList.add("spin");

    playSpinSoundSequence();
    const outcome = getRandomOutcomeWeighted();

    setTimeout(() => {
      resultado.innerText = "Resultado: " + outcome.label;

      if (outcome.type === "saldoLibre" && outcome.amount) {
        saldoLibre += outcome.amount;
        actualizarSaldos();
        playWinSound();
        showRewardPopup("libre", outcome);
      } else if (outcome.type === "saldoLibreJackpot" && outcome.amount) {
        saldoLibre += outcome.amount;
        actualizarSaldos();
        playJackpotSound();
        showRewardPopup("jackpot", outcome);
      } else if ((outcome.type === "saldoLightMueble" || outcome.type === "saldoLightFerre") && outcome.amount) {
        saldoLight += outcome.amount;
        actualizarSaldos();
        playWinSound();
        if (outcome.type === "saldoLightMueble") {
          showRewardPopup("lightning-mueble", outcome);
        } else {
          showRewardPopup("lightning-ferre", outcome);
        }
      } else if (outcome.type === "descuentoPizza") {
        agregarCupon({ brand: "PizzaRocket", description: "30% de descuento en PizzaRocket" });
        playWinSound();
        showRewardPopup("descuento", outcome);
      } else if (outcome.type === "none") {
        playLoseSound();
      } else {
        playWinSound();
      }

      if (tiradasRestantes <= 0) startCountdown12h();

      btn.disabled = false;
      isSpinning   = false;
    }, 1500);
  }

  document.getElementById("user-avatar").addEventListener("click", function (e) {
    e.stopPropagation();
    const menu = document.getElementById("user-menu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
  });

  window.addEventListener("click", function(e) {
    const menu = document.getElementById("user-menu");
    if (!e.target.closest("#user-menu") && !e.target.closest("#user-avatar")) {
      menu.style.display = "none";
    }
  });

  function openProfileOverlay() {
    const menu = document.getElementById("user-menu");
    menu.style.display = "none";

    document.getElementById("profile-name").value =
      profileData.nombre || currentUserName || "";
    document.getElementById("profile-address").value =
      profileData.direccion || "";
    document.getElementById("profile-birthdate").value =
      profileData.fechaNacimiento || "";
    document.getElementById("profile-phone").value =
      profileData.telefono || "";

    document.getElementById("profile-overlay").style.display = "flex";
  }

  function closeProfileOverlay() {
    document.getElementById("profile-overlay").style.display = "none";
  }

  document.getElementById("profile-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const nombre = document.getElementById("profile-name").value.trim();
    const direccion = document.getElementById("profile-address").value.trim();
    const fechaNac = document.getElementById("profile-birthdate").value;
    const telefono = document.getElementById("profile-phone").value.trim();

    if (nombre) {
      currentUserName = nombre;
      applyUserName();
      profileData.nombre = nombre;
      if (currentUser) {
        try {
          await currentUser.updateProfile({ displayName: nombre });
        } catch (e) {
          console.error(e);
        }
      }
    }

    profileData.direccion = direccion;
    profileData.fechaNacimiento = fechaNac;
    profileData.telefono = telefono;

    saveProfileForUser();
    closeProfileOverlay();
  });

  function showScreen(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
  }

  function goToHome() {
    cellIntervals.forEach(i => clearInterval(i));
    cellIntervals = [];
    showScreen("home-screen");
  }

  function goToCellphones() {
    showScreen("cellphones-screen");
    renderCellphones();
  }

  function goToInviteScreen() {
    showScreen("invite-screen");
    updateReferralLink();
  }

  document.addEventListener("click", function(e) {
    const cat = e.target.closest(".categoria");
    if (!cat) return;
    const type = cat.getAttribute("data-cat");
    if (type === "celulares") {
      goToCellphones();
    } else {
      alert("Esta categor√≠a estar√° disponible pr√≥ximamente en Comodity üëÄ");
    }
  });

  const cellphones = [
    {
      id: "cell1",
      name: "Samsung Galaxy S23 256GB",
      img: "https://images.samsung.com/is/image/samsung/p6pim/latin/2302/gallery/latin-galaxy-s23-s911-sm-s911bzidgto-534859593?$650_519_PNG$",
      priceNow: 29999
    },
    {
      id: "cell2",
      name: "iPhone 14 128GB",
      img: "https://store.storeimages.cdn-apple.com/4668/as-images.apple.com/is/iphone-14-blue-select-202209?wid=940&hei=1112&fmt=png-alpha&.v=1661027786801",
      priceNow: 38999
    },
    {
      id: "cell3",
      name: "Xiaomi Redmi Note 13 Pro",
      img: "https://i01.appmifile.com/webfile/globalimg/products/pc/redmi-note-13-pro-5g/specs01.png",
      priceNow: 21999
    },
    {
      id: "cell4",
      name: "Motorola Edge 40 Neo",
      img: "https://motorolaus.vtexassets.com/arquivos/ids/162093-800-auto?v=638293436464900000&width=800&height=auto&aspect=true",
      priceNow: 18999
    }
  ];

  function getOriginalPriceFromDiscount(nowPrice, discountPercent) {
    return Math.round(nowPrice / (1 - discountPercent / 100));
  }

  function formatPriceUY(uy) {
    return uy.toLocaleString("es-UY", { minimumFractionDigits: 0 });
  }

  function getEndOfDayTimestamp() {
    const now = new Date();
    const end = new Date(now);
    end.setHours(23, 59, 59, 999);
    return end.getTime();
  }

  function renderCellphones() {
    const grid = document.getElementById("cellphones-grid");
    grid.innerHTML = "";
    cellIntervals.forEach(i => clearInterval(i));
    cellIntervals = [];

    const deadline = getEndOfDayTimestamp();

    cellphones.forEach(cell => {
      const priceNow = cell.priceNow;
      const priceOld = getOriginalPriceFromDiscount(priceNow, 20);

      const card = document.createElement("div");
      card.className = "cell-card";
      card.setAttribute("data-id", cell.id);

      card.innerHTML = `
        <div class="cell-img-wrap">
          <img src="${cell.img}" alt="${cell.name}">
        </div>
        <div class="cell-body">
          <div class="cell-name">${cell.name}</div>
          <div class="cell-prices">
            <div class="cell-price-old">$${formatPriceUY(priceOld)}</div>
            <div class="cell-price-now">$${formatPriceUY(priceNow)}</div>
          </div>
          <div class="cell-discount-pill">
            <span>üî•</span><span>20% OFF hoy</span>
          </div>
          <div class="cell-timer" data-deadline="${deadline}">
            Termina en --
          </div>
        </div>
      `;

      card.addEventListener("click", () => {
        openCellDetail(cell, priceOld);
      });

      grid.appendChild(card);
    });

    document.querySelectorAll(".cell-timer").forEach(timerEl => {
      const dl = parseInt(timerEl.getAttribute("data-deadline"), 10);
      const interval = setInterval(() => {
        const now = Date.now();
        let diff = Math.max(0, dl - now);
        const h = Math.floor(diff / (1000 * 60 * 60));
        diff %= (1000 * 60 * 60);
        const m = Math.floor(diff / (1000 * 60));
        diff %= (1000 * 60);
        const s = Math.floor(diff / 1000);
        timerEl.textContent = `Termina en ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      }, 1000);
      cellIntervals.push(interval);
    });
  }

  function openCellDetail(cell, priceOld) {
    const overlay = document.getElementById("cell-detail-overlay");
    const tEl = document.getElementById("cell-detail-title");
    const imgEl = document.getElementById("cell-detail-img");
    const pricesEl = document.getElementById("cell-detail-prices");
    const extraEl = document.getElementById("cell-detail-extra");

    tEl.textContent = cell.name;
    imgEl.src = cell.img;

    const nowPrice = cell.priceNow;
    pricesEl.innerHTML = `
      <div><strong>Precio actual:</strong> $${formatPriceUY(nowPrice)} (20% OFF)</div>
      <div>Antes: <span style="text-decoration:line-through;color:#888;">$${formatPriceUY(priceOld)}</span></div>
    `;

    extraEl.innerHTML = `
      <div><strong>Vendedor:</strong> Comodity Store Oficial</div>
      <div><strong>Reputaci√≥n:</strong> ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4.8/5) ‚Ä¢ 1.250 ventas concretadas</div>
      <div><strong>Ubicaci√≥n:</strong> Montevideo, Uruguay</div>
      <div><strong>Env√≠o:</strong> Gratis en compras superiores a $2.000 ‚Ä¢ Llega entre 24 y 48 hs</div>
      <div><strong>Medios de pago:</strong> Tarjetas de cr√©dito, d√©bito y billeteras digitales.</div>
    `;

    overlay.style.display = "flex";
  }

  function closeCellDetail() {
    document.getElementById("cell-detail-overlay").style.display = "none";
  }

  /* SORTEO FECHA (2 semanas en el futuro) */

  function updateSorteoDate() {
    const el = document.getElementById("sorteo-date-text");
    if (!el) return;
    const now = new Date();
    const future = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
    const dia = future.getDate().toString().padStart(2, "0");
    const mes = (future.getMonth() + 1).toString().padStart(2, "0");
    const anio = future.getFullYear();
    el.textContent = `${dia}/${mes}/${anio}`;
  }

  /* OFERTAS - TIMERS */

  const offersConfig = {
    auris:   { hoursFromNow: 24 },   // hasta ma√±ana
    fiter:   { hoursFromNow: 70 },
    zapatillas: { hoursFromNow: 30 },
    tv:      { hoursFromNow: 16 }
  };

  function updateOffersTimers() {
    const now = Date.now();
    Object.entries(offersConfig).forEach(([id, cfg]) => {
      const el = document.querySelector(`.offer-timer[data-offer-id="${id}"]`);
      if (!el) return;
      if (!cfg.deadline) {
        cfg.deadline = now + cfg.hoursFromNow * 60 * 60 * 1000;
      }
      let diff = Math.max(0, cfg.deadline - now);
      const h = Math.floor(diff / (1000 * 60 * 60));
      diff %= (1000 * 60 * 60);
      const m = Math.floor(diff / (1000 * 60));
      diff %= (1000 * 60);
      const s = Math.floor(diff / 1000);
      el.textContent = `Termina en ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    });
  }

  /* INVITAR ‚Äì LINK REFERIDOS */

  function updateReferralLink() {
    const el = document.getElementById("referral-link");
    if (!el) return;
    const base = "https://comodity.app/invite";
    const uid = currentUser ? currentUser.uid : "demo";
    const link = `${base}?u=${encodeURIComponent(uid)}`;
    lastReferralLink = link;
    el.textContent = link;
  }

  async function copyReferralLink() {
    if (!lastReferralLink) updateReferralLink();
    try {
      await navigator.clipboard.writeText(lastReferralLink);
      alert("Link copiado al portapapeles");
    } catch (e) {
      console.error(e);
      alert("No se pudo copiar el link. Copialo manualmente.");
    }
  }

  /* INIT */

  window.addEventListener("load", () => {
    document.getElementById("login-name-group").style.display = "none";
    updateSorteoDate();
    updateReferralLink();
    updateOffersTimers();
    offersInterval = setInterval(updateOffersTimers, 1000);
  });
</script>

</body>
</html>
